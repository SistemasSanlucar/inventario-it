<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Inventario IT - Sanlucar</title>
    <script src="https://alcdn.msauth.net/browser/2.38.1/js/msal-browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0e14;
            --bg-secondary: #151a23;
            --bg-tertiary: #1e252f;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --accent-green: #3fb950;
            --accent-blue: #58a6ff;
            --accent-orange: #f97316;
            --accent-red: #ef4444;
            --accent-purple: #a855f7;
            --border: #30363d;
            --shadow: rgba(0, 0, 0, 0.5);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, #0d1117 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: var(--bg-secondary);
            padding: 60px 50px;
            border-radius: 20px;
            border: 1px solid var(--border);
            box-shadow: 0 20px 60px var(--shadow);
            text-align: center;
            max-width: 500px;
            width: 100%;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .login-box h1 {
            font-size: 32px;
            margin-bottom: 16px;
        }

        .login-box h1::before {
            content: "üì¶";
            display: block;
            font-size: 64px;
            margin-bottom: 16px;
        }

        .login-box p {
            color: var(--text-secondary);
            margin-bottom: 32px;
            line-height: 1.6;
        }

        .button {
            padding: 16px 32px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
            width: 100%;
        }

        .button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px var(--shadow);
        }

        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .button-primary { 
            background: var(--accent-blue); 
            color: white; 
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .success-message, .error-message {
            border-radius: 12px;
            padding: 16px 20px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideDown 0.3s ease;
        }

        .success-message {
            background: rgba(63, 185, 80, 0.15);
            border: 2px solid var(--accent-green);
            color: var(--accent-green);
        }

        .error-message {
            background: rgba(239, 68, 68, 0.15);
            border: 2px solid var(--accent-red);
            color: var(--accent-red);
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            animation: fadeIn 0.5s ease;
        }

        .header {
            background: var(--bg-secondary);
            padding: 24px 32px;
            border-radius: 16px;
            margin-bottom: 24px;
            border: 1px solid var(--border);
            box-shadow: 0 8px 24px var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
        }

        .header h1::before {
            content: "üì¶ ";
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .user-badge {
            padding: 8px 16px;
            background: rgba(88, 166, 255, 0.15);
            border: 1px solid var(--accent-blue);
            border-radius: 8px;
            color: var(--accent-blue);
            font-size: 14px;
            font-weight: 600;
        }

        .content-box {
            background: var(--bg-secondary);
            padding: 40px;
            border-radius: 16px;
            border: 1px solid var(--border);
            box-shadow: 0 8px 24px var(--shadow);
        }

        .info-grid {
            display: grid;
            gap: 16px;
            margin-top: 24px;
        }

        .info-item {
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border-left: 4px solid var(--accent-blue);
        }

        .info-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .info-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .button-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        @media (max-width: 768px) {
            .login-box {
                padding: 40px 30px;
            }
            
            .app-container {
                padding: 12px;
            }
            
            .header {
                padding: 20px;
            }
            
            .content-box {
                padding: 24px;
            }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // Configuraci√≥n MSAL
        const msalConfig = {
            auth: {
                clientId: '80ba264e-e1fc-4749-bf00-2c25b93b4ee5',
                authority: 'https://login.microsoftonline.com/f37778d8-59b2-4e5e-a56b-08eb8ad3c13a',
                redirectUri: window.location.href.split('?')[0].split('#')[0] // URL completa sin query params
            },
            cache: {
                cacheLocation: 'localStorage',
                storeAuthStateInCookie: false
            }
        };

        const loginRequest = {
            scopes: ['User.Read', 'Sites.ReadWrite.All']
        };

        let msalInstance;
        let currentUser = null;
        let accessToken = null;

        // Inicializar MSAL
        async function initializeMSAL() {
            try {
                msalInstance = new msal.PublicClientApplication(msalConfig);
                await msalInstance.initialize();
                console.log('‚úì MSAL inicializado');
                return true;
            } catch (error) {
                console.error('‚úó Error inicializando MSAL:', error);
                return false;
            }
        }

        // Verificar autenticaci√≥n
        async function checkAuth() {
            const accounts = msalInstance.getAllAccounts();
            
            if (accounts.length > 0) {
                const account = accounts[0];
                msalInstance.setActiveAccount(account);
                
                try {
                    const response = await msalInstance.acquireTokenSilent({
                        ...loginRequest,
                        account: account
                    });
                    
                    accessToken = response.accessToken;
                    currentUser = {
                        name: account.name,
                        email: account.username
                    };
                    
                    return true;
                } catch (error) {
                    console.error('Error adquiriendo token:', error);
                    return false;
                }
            }
            
            return false;
        }

        // Login
        async function login() {
            try {
                showLoading('Iniciando sesi√≥n...');
                
                const response = await msalInstance.loginPopup(loginRequest);
                
                msalInstance.setActiveAccount(response.account);
                accessToken = response.accessToken;
                currentUser = {
                    name: response.account.name,
                    email: response.account.username
                };
                
                showSuccess(`¬°Bienvenido, ${currentUser.name}!`);
                setTimeout(renderApp, 1000);
                
            } catch (error) {
                console.error('Error en login:', error);
                showError('Error al iniciar sesi√≥n. Por favor, intenta de nuevo.');
            }
        }

        // Logout
        async function logout() {
            try {
                await msalInstance.logoutPopup();
                currentUser = null;
                accessToken = null;
                renderApp();
            } catch (error) {
                console.error('Error en logout:', error);
            }
        }

        // Funci√≥n para llamar a Microsoft Graph API
        async function callGraphAPI(endpoint) {
            try {
                const response = await fetch(`https://graph.microsoft.com/v1.0${endpoint}`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('Error llamando a Graph API:', error);
                throw error;
            }
        }

        // UI: Mostrar carga
        function showLoading(message) {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="login-screen">
                    <div class="login-box">
                        <div class="loading-spinner" style="margin: 0 auto 16px;"></div>
                        <p>${message}</p>
                    </div>
                </div>
            `;
        }

        // UI: Mostrar √©xito
        function showSuccess(message) {
            const existing = document.querySelector('.success-message');
            if (existing) existing.remove();
            
            const msg = document.createElement('div');
            msg.className = 'success-message';
            msg.innerHTML = `<span>‚úì</span><span>${message}</span>`;
            document.getElementById('app').prepend(msg);
            
            setTimeout(() => msg.remove(), 4000);
        }

        // UI: Mostrar error
        function showError(message) {
            const existing = document.querySelector('.error-message');
            if (existing) existing.remove();
            
            const msg = document.createElement('div');
            msg.className = 'error-message';
            msg.innerHTML = `<span>‚úó</span><span>${message}</span>`;
            document.getElementById('app').prepend(msg);
            
            setTimeout(() => msg.remove(), 4000);
        }

        // UI: Renderizar pantalla de login
        function renderLogin() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="login-screen">
                    <div class="login-box">
                        <h1>Sistema de Inventario IT</h1>
                        <p style="font-size: 14px; color: var(--accent-purple); font-weight: 600; margin-bottom: 12px;">
                            Sanlucar Fruit
                        </p>
                        <p>
                            Inicia sesi√≥n con tu cuenta corporativa de Microsoft 365 para acceder al sistema de gesti√≥n de inventario.
                        </p>
                        <button class="button button-primary" onclick="login()">
                            üîê Iniciar Sesi√≥n con Microsoft
                        </button>
                        <p style="font-size: 12px; margin-top: 24px;">
                            üí° Usa tu cuenta @sanlucar.com
                        </p>
                    </div>
                </div>
            `;
        }

        // UI: Renderizar app autenticada
        function renderAuthenticatedApp() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="app-container">
                    <header class="header">
                        <h1>Sistema de Inventario IT</h1>
                        <div class="user-info">
                            <div class="user-badge">
                                üë§ ${currentUser.name}
                            </div>
                            <button class="button button-secondary" onclick="logout()" style="padding: 8px 16px;">
                                üö™ Cerrar Sesi√≥n
                            </button>
                        </div>
                    </header>

                    <div class="content-box">
                        <h2 style="font-size: 24px; margin-bottom: 16px;">
                            üéâ ¬°Sistema Configurado Correctamente!
                        </h2>
                        <p style="color: var(--text-secondary); margin-bottom: 24px;">
                            La autenticaci√≥n con Microsoft 365 funciona perfectamente. Est√°s conectado como:
                        </p>
                        
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">Usuario</div>
                                <div class="info-value">${currentUser.name}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Email</div>
                                <div class="info-value">${currentUser.email}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Estado</div>
                                <div class="info-value" style="color: var(--accent-green);">‚úì Autenticado</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Permisos</div>
                                <div class="info-value">User.Read, Sites.ReadWrite.All</div>
                            </div>
                        </div>

                        <div style="margin-top: 32px; padding: 24px; background: rgba(88, 166, 255, 0.1); border: 2px solid var(--accent-blue); border-radius: 12px;">
                            <h3 style="color: var(--accent-blue); margin-bottom: 12px;">
                                üìä Pr√≥ximos Pasos
                            </h3>
                            <p style="color: var(--text-secondary); line-height: 1.6;">
                                <strong>1.</strong> La base funciona correctamente ‚úì<br>
                                <strong>2.</strong> Ahora implementaremos las consultas a SharePoint<br>
                                <strong>3.</strong> Conectaremos las listas de inventario, t√©cnicos e historial<br>
                                <strong>4.</strong> A√±adiremos toda la interfaz completa (dashboard, gesti√≥n, etc.)
                            </p>
                        </div>

                        <div style="margin-top: 24px; padding: 16px; background: var(--bg-tertiary); border-radius: 8px;">
                            <p style="font-size: 13px; color: var(--text-secondary); text-align: center;">
                                üí° <strong>Nota:</strong> Esta es la versi√≥n base. Una vez confirmemos que funciona en GitHub Pages, 
                                integraremos toda la funcionalidad completa del sistema.
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Renderizar aplicaci√≥n seg√∫n estado
        async function renderApp() {
            const isAuth = await checkAuth();
            
            if (isAuth) {
                renderAuthenticatedApp();
            } else {
                renderLogin();
            }
        }

        // Inicializar aplicaci√≥n
        async function init() {
            showLoading('Inicializando sistema...');
            
            const msalReady = await initializeMSAL();
            
            if (!msalReady) {
                showError('Error inicializando el sistema de autenticaci√≥n');
                return;
            }
            
            await renderApp();
        }

        // Ejecutar cuando cargue la p√°gina
        window.addEventListener('load', init);
    </script>
</body>
</html>
