<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Inventario IT - Sanlucar</title>
    <script src="https://alcdn.msauth.net/browser/2.38.1/js/msal-browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0e14;
            --bg-secondary: #151a23;
            --bg-tertiary: #1e252f;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --accent-green: #3fb950;
            --accent-blue: #58a6ff;
            --accent-orange: #f97316;
            --accent-red: #ef4444;
            --accent-purple: #a855f7;
            --accent-yellow: #fbbf24;
            --border: #30363d;
            --shadow: rgba(0, 0, 0, 0.5);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, #0d1117 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            animation: fadeIn 0.5s ease;
        }

        .login-box {
            background: var(--bg-secondary);
            padding: 60px 50px;
            border-radius: 20px;
            border: 1px solid var(--border);
            box-shadow: 0 20px 60px var(--shadow);
            text-align: center;
            max-width: 500px;
            width: 100%;
        }

        .login-box h1 {
            font-size: 32px;
            margin-bottom: 16px;
        }

        .login-box h1::before {
            content: "ðŸ“¦";
            display: block;
            font-size: 64px;
            margin-bottom: 16px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .login-box p {
            color: var(--text-secondary);
            margin-bottom: 32px;
            line-height: 1.6;
        }

        /* Buttons */
        .button {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
            white-space: nowrap;
        }

        .button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px var(--shadow);
        }

        .button:active:not(:disabled) {
            transform: translateY(0);
        }

        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .button-primary { background: var(--accent-blue); color: white; }
        .button-success { background: var(--accent-green); color: white; }
        .button-warning { background: var(--accent-orange); color: white; }
        .button-danger { background: var(--accent-red); color: white; }
        .button-purple { background: var(--accent-purple); color: white; }
        .button-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Messages */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 400px;
        }

        .toast {
            background: var(--bg-secondary);
            border: 2px solid;
            border-radius: 12px;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 8px 24px var(--shadow);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .toast.success {
            border-color: var(--accent-green);
            background: rgba(63, 185, 80, 0.1);
        }

        .toast.error {
            border-color: var(--accent-red);
            background: rgba(239, 68, 68, 0.1);
        }

        .toast.warning {
            border-color: var(--accent-orange);
            background: rgba(249, 115, 22, 0.1);
        }

        .toast .icon {
            font-size: 20px;
        }

        .toast .text {
            flex: 1;
            font-size: 14px;
            font-weight: 600;
        }

        .toast.success .text { color: var(--accent-green); }
        .toast.error .text { color: var(--accent-red); }
        .toast.warning .text { color: var(--accent-orange); }

        /* App Container */
        .app-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            animation: fadeIn 0.5s ease;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            padding: 24px 32px;
            border-radius: 16px;
            margin-bottom: 24px;
            border: 1px solid var(--border);
            box-shadow: 0 8px 24px var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .header-left {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header h1::before {
            content: "ðŸ“¦";
            font-size: 32px;
        }

        .user-badges {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .user-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            font-size: 13px;
            border: 1px solid var(--border);
        }

        .user-badge.admin {
            background: rgba(168, 85, 247, 0.1);
            border-color: var(--accent-purple);
            color: var(--accent-purple);
        }

        .user-badge.technician {
            background: rgba(88, 166, 255, 0.1);
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        .header-stats {
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            font-family: 'IBM Plex Mono', monospace;
            margin-top: 4px;
        }

        .stat-value.green { color: var(--accent-green); }
        .stat-value.orange { color: var(--accent-orange); }
        .stat-value.blue { color: var(--accent-blue); }
        .stat-value.purple { color: var(--accent-purple); }

        /* Navigation */
        .nav-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .tab-button {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-button:hover:not(:disabled) {
            background: var(--bg-tertiary);
            border-color: var(--accent-blue);
            transform: translateY(-2px);
        }

        .tab-button.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }

        .tab-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Content Section */
        .content-section {
            background: var(--bg-secondary);
            padding: 32px;
            border-radius: 16px;
            border: 1px solid var(--border);
            box-shadow: 0 8px 24px var(--shadow);
            min-height: 500px;
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            align-items: center;
        }

        .toolbar-left {
            flex: 1;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            min-width: 250px;
        }

        .toolbar-right {
            display: flex;
            gap: 12px;
        }

        .search-bar {
            flex: 1;
            min-width: 250px;
            padding: 12px 16px 12px 40px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.2s ease;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%238b949e' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='m21 21-4.35-4.35'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: 12px center;
        }

        .search-bar:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 4px rgba(88, 166, 255, 0.1);
        }

        .filter-select {
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            min-width: 150px;
            cursor: pointer;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }

        .dashboard-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            transition: all 0.2s ease;
        }

        .dashboard-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px var(--shadow);
        }

        .dashboard-card h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .chart-container {
            position: relative;
            height: 250px;
        }

        /* Inventory Grid */
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 16px;
            margin-top: 24px;
        }

        .inventory-card {
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .inventory-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--accent-blue);
        }

        .inventory-card.low-stock::before { background: var(--accent-orange); }
        .inventory-card.out-of-stock::before { background: var(--accent-red); }

        .inventory-card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-4px);
            box-shadow: 0 8px 24px var(--shadow);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .card-category {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .card-barcode {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 12px;
            color: var(--accent-blue);
            background: var(--bg-primary);
            padding: 4px 8px;
            border-radius: 4px;
        }

        .card-info {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 16px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .info-label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .info-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .stock-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            font-family: 'IBM Plex Mono', monospace;
        }

        .stock-badge.available {
            background: rgba(63, 185, 80, 0.15);
            color: var(--accent-green);
        }

        .stock-badge.low {
            background: rgba(249, 115, 22, 0.15);
            color: var(--accent-orange);
        }

        .stock-badge.out {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
        }

        .card-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
            flex-wrap: wrap;
        }

        .card-actions .button {
            flex: 1;
            padding: 10px;
            font-size: 13px;
            min-width: 100px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .empty-state-text {
            font-size: 14px;
        }

        /* Loading State */
        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            gap: 16px;
        }

        .loading-state .loading-spinner {
            width: 40px;
            height: 40px;
            border-width: 4px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            animation: fadeIn 0.2s ease;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: 16px;
            border: 1px solid var(--border);
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px var(--shadow);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 24px 32px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            z-index: 10;
        }

        .modal-title {
            font-size: 22px;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
            line-height: 1;
            transition: color 0.2s ease;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }

        .modal-close:hover {
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }

        .modal-body {
            padding: 32px;
        }

        .modal-footer {
            padding: 24px 32px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            position: sticky;
            bottom: 0;
            background: var(--bg-secondary);
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 15px;
            transition: all 0.2s ease;
            font-family: 'Inter', sans-serif;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 4px rgba(88, 166, 255, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .app-container {
                padding: 12px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 22px;
            }

            .inventory-grid {
                grid-template-columns: 1fr;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .toolbar {
                flex-direction: column;
            }

            .toolbar-left,
            .toolbar-right {
                width: 100%;
            }

            .content-section {
                padding: 20px;
            }

            .modal {
                margin: 0;
                max-height: 100vh;
                border-radius: 0;
            }
        }
    </style>
</head>
<body>
    <div id="toast-container" class="toast-container"></div>
    <div id="root"></div>

    <script>
        // ==========================================
        // CONFIGURACIÃ“N
        // ==========================================
        
        const CONFIG = {
            sharepoint: {
                siteId: 'sanlucarfruit.sharepoint.com,ec4c8c0e-b8f0-4e5e-a56b-08eb8ad3c13a,5e3d7d8b-9b09-4c57-bb38-346bb376731d',
                lists: {
                    inventario: 'StockControl_InventarioIT',
                    tecnicos: 'StockControl_TecnicosIT',
                    historial: 'StockControl_HistorialIT',
                    admins: 'StockControl_Admins'
                }
            },
            msal: {
                clientId: '80ba264e-e1fc-4749-bf00-2c25b93b4ee5',
                authority: 'https://login.microsoftonline.com/f37778d8-59b2-4e5e-a56b-08eb8ad3c13a',
                redirectUri: window.location.href.split('?')[0].split('#')[0]
            },
            scopes: ['User.Read', 'Sites.ReadWrite.All']
        };

        // ==========================================
        // MSAL SETUP
        // ==========================================
        
        let msalInstance;
        let graphClient;

        async function initializeMSAL() {
            try {
                msalInstance = new msal.PublicClientApplication({
                    auth: CONFIG.msal,
                    cache: {
                        cacheLocation: 'localStorage',
                        storeAuthStateInCookie: false
                    }
                });
                
                await msalInstance.initialize();
                return true;
            } catch (error) {
                console.error('Error inicializando MSAL:', error);
                return false;
            }
        }

        async function getAccessToken() {
            const accounts = msalInstance.getAllAccounts();
            
            if (accounts.length === 0) {
                return null;
            }

            try {
                const response = await msalInstance.acquireTokenSilent({
                    scopes: CONFIG.scopes,
                    account: accounts[0]
                });
                return response.accessToken;
            } catch (error) {
                console.error('Error obteniendo token:', error);
                return null;
            }
        }

        async function login() {
            try {
                const response = await msalInstance.loginPopup({
                    scopes: CONFIG.scopes
                });
                
                msalInstance.setActiveAccount(response.account);
                return {
                    name: response.account.name,
                    email: response.account.username,
                    token: response.accessToken
                };
            } catch (error) {
                console.error('Error en login:', error);
                throw error;
            }
        }

        async function logout() {
            try {
                await msalInstance.logoutPopup();
            } catch (error) {
                console.error('Error en logout:', error);
            }
        }

        // ==========================================
        // MICROSOFT GRAPH API CLIENT
        // ==========================================
        
        class GraphAPIClient {
            constructor(accessToken) {
                this.accessToken = accessToken;
                this.baseUrl = 'https://graph.microsoft.com/v1.0';
            }

            async request(endpoint, options = {}) {
                const url = `${this.baseUrl}${endpoint}`;
                const headers = {
                    'Authorization': `Bearer ${this.accessToken}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                };

                try {
                    const response = await fetch(url, {
                        ...options,
                        headers
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error?.message || `HTTP ${response.status}`);
                    }

                    return await response.json();
                } catch (error) {
                    console.error('Graph API Error:', error);
                    throw error;
                }
            }

            // Listas de SharePoint
            async getListItems(listName) {
                const endpoint = `/sites/${CONFIG.sharepoint.siteId}/lists/${listName}/items?expand=fields`;
                const result = await this.request(endpoint);
                return result.value.map(item => item.fields);
            }

            async createListItem(listName, data) {
                const endpoint = `/sites/${CONFIG.sharepoint.siteId}/lists/${listName}/items`;
                const result = await this.request(endpoint, {
                    method: 'POST',
                    body: JSON.stringify({ fields: data })
                });
                return result.fields;
            }

            async updateListItem(listName, itemId, data) {
                const endpoint = `/sites/${CONFIG.sharepoint.siteId}/lists/${listName}/items/${itemId}/fields`;
                const result = await this.request(endpoint, {
                    method: 'PATCH',
                    body: JSON.stringify(data)
                });
                return result;
            }

            async deleteListItem(listName, itemId) {
                const endpoint = `/sites/${CONFIG.sharepoint.siteId}/lists/${listName}/items/${itemId}`;
                await this.request(endpoint, {
                    method: 'DELETE'
                });
                return true;
            }

            async getCurrentUser() {
                return await this.request('/me');
            }
        }

        // ==========================================
        // TOAST NOTIFICATIONS
        // ==========================================
        
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: 'âœ“',
                error: 'âœ—',
                warning: 'âš '
            };
            
            toast.innerHTML = `
                <span class="icon">${icons[type] || 'â€¢'}</span>
                <span class="text">${message}</span>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        // ==========================================
        // UTILITY FUNCTIONS
        // ==========================================
        
        function exportToCSV(data, filename) {
            if (!data || data.length === 0) {
                showToast('No hay datos para exportar', 'warning');
                return;
            }
            
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(field => {
                    let value = row[field] || '';
                    if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                        value = `"${value.replace(/"/g, '""')}"`;
                    }
                    return value;
                }).join(','))
            ].join('\n');

            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${filename}_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showToast('Archivo exportado correctamente', 'success');
        }

        function generateBarcode(code) {
            const canvas = document.createElement('canvas');
            JsBarcode(canvas, code, {
                format: 'CODE128',
                width: 2,
                height: 100,
                displayValue: true
            });
            return canvas.toDataURL('image/png');
        }

        // ==========================================
        // APPLICATION STATE
        // ==========================================
        
        class AppState {
            constructor() {
                this.user = null;
                this.isAdmin = false;
                this.inventory = [];
                this.technicians = [];
                this.history = [];
                this.activeTab = 'dashboard';
                this.loading = true;
                this.listeners = [];
            }

            setState(updates) {
                Object.assign(this, updates);
                this.notify();
            }

            subscribe(listener) {
                this.listeners.push(listener);
                return () => {
                    this.listeners = this.listeners.filter(l => l !== listener);
                };
            }

            notify() {
                this.listeners.forEach(listener => listener(this));
            }
        }

        const appState = new AppState();

        // ==========================================
        // DATA MANAGER
        // ==========================================
        
        class DataManager {
            constructor(graphClient) {
                this.graph = graphClient;
            }

            async loadAllData() {
                try {
                    const [inventario, tecnicos, historial, admins] = await Promise.all([
                        this.graph.getListItems(CONFIG.sharepoint.lists.inventario),
                        this.graph.getListItems(CONFIG.sharepoint.lists.tecnicos),
                        this.graph.getListItems(CONFIG.sharepoint.lists.historial),
                        this.graph.getListItems(CONFIG.sharepoint.lists.admins)
                    ]);

                    return {
                        inventory: inventario.map(item => ({
                            id: item.id,
                            nombre: item.Nombre || item.Title,
                            categoria: item.Categoria,
                            barcode: item.CodigoBarras,
                            stock: parseInt(item.Stock) || 0,
                            stockMinimo: parseInt(item.StockMinimo) || 0,
                            ubicacion: item.Ubicacion || ''
                        })),
                        technicians: tecnicos.map(item => ({
                            id: item.id,
                            nombre: item.NombreTecnico || item.Title,
                            codigo: item.CodigoTecnico,
                            email: item.Email,
                            activo: item.Activo === true || item.Activo === 'Yes'
                        })),
                        history: historial.map(item => ({
                            id: item.id,
                            fecha: item.FechaHora || item.Created,
                            tipo: item.TipoMovimiento,
                            producto: item.Producto,
                            cantidad: parseInt(item.Cantidad) || 0,
                            ticket: item.Ticket || '',
                            usuario: item.Usuario || '',
                            tecnico: item.Tecnico || '',
                            firma: item.Firma || null
                        })).sort((a, b) => new Date(b.fecha) - new Date(a.fecha)),
                        admins: admins
                    };
                } catch (error) {
                    console.error('Error cargando datos:', error);
                    throw error;
                }
            }

            async createInventoryItem(data) {
                const item = await this.graph.createListItem(CONFIG.sharepoint.lists.inventario, {
                    Title: data.nombre,
                    Nombre: data.nombre,
                    Categoria: data.categoria,
                    CodigoBarras: data.barcode,
                    Stock: data.stock,
                    StockMinimo: data.stockMinimo,
                    Ubicacion: data.ubicacion
                });
                return item;
            }

            async updateInventoryItem(itemId, data) {
                await this.graph.updateListItem(CONFIG.sharepoint.lists.inventario, itemId, {
                    Nombre: data.nombre,
                    Categoria: data.categoria,
                    Stock: data.stock,
                    StockMinimo: data.stockMinimo,
                    Ubicacion: data.ubicacion
                });
            }

            async deleteInventoryItem(itemId) {
                await this.graph.deleteListItem(CONFIG.sharepoint.lists.inventario, itemId);
            }

            async addToHistory(data) {
                await this.graph.createListItem(CONFIG.sharepoint.lists.historial, {
                    Title: `${data.tipo} - ${data.producto}`,
                    TipoMovimiento: data.tipo,
                    Producto: data.producto,
                    Cantidad: data.cantidad,
                    Ticket: data.ticket || '',
                    Usuario: data.usuario || '',
                    Tecnico: data.tecnico || '',
                    FechaHora: new Date().toISOString(),
                    Firma: data.firma || ''
                });
            }
        }

        // ==========================================
        // UI COMPONENTS
        // ==========================================
        
        function LoginScreen({ onLogin }) {
            const [loading, setLoading] = React.useState(false);

            const handleLogin = async () => {
                setLoading(true);
                try {
                    await onLogin();
                } catch (error) {
                    showToast('Error al iniciar sesiÃ³n', 'error');
                } finally {
                    setLoading(false);
                }
            };

            return React.createElement('div', { className: 'login-screen' },
                React.createElement('div', { className: 'login-box' },
                    React.createElement('h1', null, 'Sistema de Inventario IT'),
                    React.createElement('p', { style: { fontSize: '14px', color: 'var(--accent-purple)', fontWeight: '600', marginBottom: '12px' } },
                        'Sanlucar Fruit'
                    ),
                    React.createElement('p', null,
                        'Inicia sesiÃ³n con tu cuenta corporativa de Microsoft 365 para acceder al sistema de gestiÃ³n de inventario.'
                    ),
                    React.createElement('button', {
                        className: 'button button-primary',
                        onClick: handleLogin,
                        disabled: loading,
                        style: { width: '100%', marginTop: '16px' }
                    },
                        loading ? React.createElement('span', { className: 'loading-spinner' }) : 'ðŸ”',
                        loading ? ' Iniciando sesiÃ³n...' : ' Iniciar SesiÃ³n con Microsoft'
                    ),
                    React.createElement('p', { style: { fontSize: '12px', marginTop: '24px' } },
                        'ðŸ’¡ Usa tu cuenta @sanlucar.com'
                    )
                )
            );
        }

        function Dashboard({ state }) {
            const stats = {
                totalProductos: state.inventory.length,
                totalUnidades: state.inventory.reduce((sum, item) => sum + item.stock, 0),
                stockBajo: state.inventory.filter(item => item.stock > 0 && item.stock <= item.stockMinimo).length,
                sinStock: state.inventory.filter(item => item.stock === 0).length,
                movimientosHoy: state.history.filter(h => 
                    new Date(h.fecha).toDateString() === new Date().toDateString()
                ).length,
                tecnicosActivos: state.technicians.filter(t => t.activo).length
            };

            return React.createElement('div', null,
                React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' } },
                    React.createElement('h2', { style: { fontSize: '24px', fontWeight: '700' } }, 'ðŸ“Š Dashboard'),
                    React.createElement('button', {
                        className: 'button button-success',
                        onClick: () => exportToCSV(state.inventory, 'inventario_completo')
                    }, 'ðŸ“¥ Exportar Inventario')
                ),
                
                React.createElement('div', { className: 'dashboard-grid' },
                    React.createElement('div', { className: 'dashboard-card' },
                        React.createElement('h3', null, 'ðŸ“¦ Resumen de Stock'),
                        React.createElement('div', { style: { display: 'flex', flexDirection: 'column', gap: '12px' } },
                            React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', padding: '12px', background: 'var(--bg-primary)', borderRadius: '8px' } },
                                React.createElement('span', { style: { color: 'var(--text-secondary)', fontSize: '14px' } }, 'Total Productos'),
                                React.createElement('span', { style: { color: 'var(--accent-blue)', fontSize: '18px', fontWeight: '700' } }, stats.totalProductos)
                            ),
                            React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', padding: '12px', background: 'var(--bg-primary)', borderRadius: '8px' } },
                                React.createElement('span', { style: { color: 'var(--text-secondary)', fontSize: '14px' } }, 'Total Unidades'),
                                React.createElement('span', { style: { color: 'var(--accent-green)', fontSize: '18px', fontWeight: '700' } }, stats.totalUnidades)
                            ),
                            React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', padding: '12px', background: 'var(--bg-primary)', borderRadius: '8px' } },
                                React.createElement('span', { style: { color: 'var(--text-secondary)', fontSize: '14px' } }, 'Stock Bajo'),
                                React.createElement('span', { style: { color: 'var(--accent-orange)', fontSize: '18px', fontWeight: '700' } }, stats.stockBajo)
                            ),
                            React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', padding: '12px', background: 'var(--bg-primary)', borderRadius: '8px' } },
                                React.createElement('span', { style: { color: 'var(--text-secondary)', fontSize: '14px' } }, 'Sin Stock'),
                                React.createElement('span', { style: { color: 'var(--accent-red)', fontSize: '18px', fontWeight: '700' } }, stats.sinStock)
                            )
                        )
                    ),
                    
                    React.createElement('div', { className: 'dashboard-card' },
                        React.createElement('h3', null, 'ðŸ“ˆ Actividad'),
                        React.createElement('div', { style: { display: 'flex', flexDirection: 'column', gap: '12px' } },
                            React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', padding: '12px', background: 'var(--bg-primary)', borderRadius: '8px' } },
                                React.createElement('span', { style: { color: 'var(--text-secondary)', fontSize: '14px' } }, 'Movimientos Hoy'),
                                React.createElement('span', { style: { color: 'var(--accent-purple)', fontSize: '18px', fontWeight: '700' } }, stats.movimientosHoy)
                            ),
                            React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', padding: '12px', background: 'var(--bg-primary)', borderRadius: '8px' } },
                                React.createElement('span', { style: { color: 'var(--text-secondary)', fontSize: '14px' } }, 'Total Movimientos'),
                                React.createElement('span', { style: { color: 'var(--accent-blue)', fontSize: '18px', fontWeight: '700' } }, state.history.length)
                            ),
                            React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', padding: '12px', background: 'var(--bg-primary)', borderRadius: '8px' } },
                                React.createElement('span', { style: { color: 'var(--text-secondary)', fontSize: '14px' } }, 'TÃ©cnicos Activos'),
                                React.createElement('span', { style: { color: 'var(--accent-green)', fontSize: '18px', fontWeight: '700' } }, stats.tecnicosActivos)
                            )
                        )
                    ),
                    
                    React.createElement('div', { className: 'dashboard-card' },
                        React.createElement('h3', null, 'ðŸ† Top 5 Productos'),
                        React.createElement('div', { style: { display: 'flex', flexDirection: 'column', gap: '8px' } },
                            state.inventory
                                .map(item => ({
                                    ...item,
                                    count: state.history.filter(h => h.producto === item.nombre && h.tipo === 'Salida').length
                                }))
                                .sort((a, b) => b.count - a.count)
                                .slice(0, 5)
                                .map((item, idx) =>
                                    React.createElement('div', {
                                        key: item.id,
                                        style: { display: 'flex', justifyContent: 'space-between', padding: '12px', background: 'var(--bg-primary)', borderRadius: '8px' }
                                    },
                                        React.createElement('span', { style: { color: 'var(--text-secondary)', fontSize: '14px' } }, `${idx + 1}. ${item.nombre}`),
                                        React.createElement('span', { style: { color: 'var(--accent-yellow)', fontSize: '18px', fontWeight: '700' } }, item.count)
                                    )
                                )
                        )
                    ),
                    
                    React.createElement('div', { className: 'dashboard-card' },
                        React.createElement('h3', null, 'âš ï¸ Productos CrÃ­ticos'),
                        state.inventory.filter(item => item.stock > 0 && item.stock <= item.stockMinimo).length > 0 ?
                            React.createElement('div', { style: { display: 'flex', flexDirection: 'column', gap: '8px' } },
                                state.inventory
                                    .filter(item => item.stock > 0 && item.stock <= item.stockMinimo)
                                    .slice(0, 5)
                                    .map(item =>
                                        React.createElement('div', {
                                            key: item.id,
                                            style: { display: 'flex', justifyContent: 'space-between', padding: '12px', background: 'var(--bg-primary)', borderRadius: '8px' }
                                        },
                                            React.createElement('span', { style: { color: 'var(--text-secondary)', fontSize: '14px' } }, item.nombre),
                                            React.createElement('span', { style: { color: 'var(--accent-orange)', fontSize: '18px', fontWeight: '700' } }, 
                                                `${item.stock}/${item.stockMinimo}`
                                            )
                                        )
                                    )
                            ) :
                            React.createElement('div', { style: { textAlign: 'center', padding: '20px', color: 'var(--text-secondary)' } },
                                'âœ“ Todo el stock estÃ¡ en niveles Ã³ptimos'
                            )
                    )
                )
            );
        }

        function InventoryView({ state, onRefresh }) {
            const [search, setSearch] = React.useState('');
            const [filterCategory, setFilterCategory] = React.useState('all');

            const filtered = state.inventory.filter(item => {
                const matchesSearch = item.nombre.toLowerCase().includes(search.toLowerCase()) ||
                                    item.categoria.toLowerCase().includes(search.toLowerCase()) ||
                                    item.barcode.includes(search);
                const matchesCategory = filterCategory === 'all' || item.categoria === filterCategory;
                return matchesSearch && matchesCategory;
            });

            const categories = [...new Set(state.inventory.map(item => item.categoria))];

            return React.createElement('div', null,
                React.createElement('div', { className: 'toolbar' },
                    React.createElement('div', { className: 'toolbar-left' },
                        React.createElement('input', {
                            type: 'text',
                            className: 'search-bar',
                            placeholder: 'ðŸ” Buscar productos...',
                            value: search,
                            onChange: (e) => setSearch(e.target.value)
                        }),
                        React.createElement('select', {
                            className: 'filter-select',
                            value: filterCategory,
                            onChange: (e) => setFilterCategory(e.target.value)
                        },
                            React.createElement('option', { value: 'all' }, 'Todas las categorÃ­as'),
                            categories.map(cat =>
                                React.createElement('option', { key: cat, value: cat }, cat)
                            )
                        )
                    ),
                    React.createElement('div', { className: 'toolbar-right' },
                        React.createElement('button', {
                            className: 'button button-success',
                            onClick: () => exportToCSV(filtered, 'inventario')
                        }, 'ðŸ“¥ Exportar')
                    )
                ),
                
                filtered.length > 0 ?
                    React.createElement('div', { className: 'inventory-grid' },
                        filtered.map(item => {
                            const stockClass = item.stock === 0 ? 'out-of-stock' :
                                             item.stock <= item.stockMinimo ? 'low-stock' : '';
                            
                            return React.createElement('div', {
                                key: item.id,
                                className: `inventory-card ${stockClass}`
                            },
                                React.createElement('div', { className: 'card-header' },
                                    React.createElement('div', null,
                                        React.createElement('div', { className: 'card-title' }, item.nombre),
                                        React.createElement('div', { className: 'card-category' }, item.categoria)
                                    ),
                                    React.createElement('div', { className: 'card-barcode' }, item.barcode)
                                ),
                                
                                React.createElement('div', { className: 'card-info' },
                                    React.createElement('div', { className: 'info-row' },
                                        React.createElement('span', { className: 'info-label' }, 'Stock Actual'),
                                        React.createElement('span', {
                                            className: `stock-badge ${item.stock === 0 ? 'out' : item.stock <= item.stockMinimo ? 'low' : 'available'}`
                                        }, `${item.stock} unidades`)
                                    ),
                                    React.createElement('div', { className: 'info-row' },
                                        React.createElement('span', { className: 'info-label' }, 'Stock MÃ­nimo'),
                                        React.createElement('span', { className: 'info-value' }, item.stockMinimo)
                                    ),
                                    React.createElement('div', { className: 'info-row' },
                                        React.createElement('span', { className: 'info-label' }, 'UbicaciÃ³n'),
                                        React.createElement('span', { className: 'info-value' }, item.ubicacion || '-')
                                    )
                                ),

                                React.createElement('div', { className: 'card-actions' },
                                    React.createElement('button', {
                                        className: 'button button-primary',
                                        disabled: item.stock === 0
                                    }, 'â¬†ï¸ Salida'),
                                    React.createElement('button', {
                                        className: 'button button-success'
                                    }, 'â¬‡ï¸ Entrada'),
                                    state.isAdmin && React.createElement('button', {
                                        className: 'button button-secondary'
                                    }, 'âœï¸ Editar')
                                )
                            );
                        })
                    ) :
                    React.createElement('div', { className: 'empty-state' },
                        React.createElement('div', { className: 'empty-state-icon' }, 'ðŸ”'),
                        React.createElement('div', { className: 'empty-state-title' }, 'No se encontraron productos'),
                        React.createElement('div', { className: 'empty-state-text' }, 'Intenta con otros tÃ©rminos de bÃºsqueda')
                    )
            );
        }

        function App() {
            const [state, setState] = React.useState({
                user: null,
                isAdmin: false,
                inventory: [],
                technicians: [],
                history: [],
                activeTab: 'dashboard',
                loading: true
            });

            React.useEffect(() => {
                initializeApp();
            }, []);

            const initializeApp = async () => {
                try {
                    const msalReady = await initializeMSAL();
                    if (!msalReady) {
                        throw new Error('Failed to initialize MSAL');
                    }

                    const accounts = msalInstance.getAllAccounts();
                    if (accounts.length === 0) {
                        setState({ ...state, loading: false });
                        return;
                    }

                    const token = await getAccessToken();
                    if (!token) {
                        setState({ ...state, loading: false });
                        return;
                    }

                    const graph = new GraphAPIClient(token);
                    const currentUser = await graph.getCurrentUser();
                    
                    const dataManager = new DataManager(graph);
                    const data = await dataManager.loadAllData();

                    const isAdmin = data.admins.some(a => 
                        a.Email.toLowerCase() === currentUser.mail.toLowerCase() && 
                        (a.Activo === true || a.Activo === 'Yes')
                    );

                    setState({
                        user: {
                            name: currentUser.displayName,
                            email: currentUser.mail
                        },
                        isAdmin,
                        inventory: data.inventory,
                        technicians: data.technicians,
                        history: data.history,
                        activeTab: 'dashboard',
                        loading: false
                    });

                    showToast(`Bienvenido, ${currentUser.displayName}`, 'success');
                } catch (error) {
                    console.error('Error inicializando app:', error);
                    showToast('Error cargando la aplicaciÃ³n', 'error');
                    setState({ ...state, loading: false });
                }
            };

            const handleLogin = async () => {
                try {
                    await login();
                    await initializeApp();
                } catch (error) {
                    showToast('Error al iniciar sesiÃ³n', 'error');
                }
            };

            const handleLogout = async () => {
                await logout();
                setState({
                    user: null,
                    isAdmin: false,
                    inventory: [],
                    technicians: [],
                    history: [],
                    activeTab: 'dashboard',
                    loading: false
                });
                showToast('SesiÃ³n cerrada correctamente', 'success');
            };

            if (state.loading) {
                return React.createElement('div', { className: 'loading-state', style: { height: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center' } },
                    React.createElement('div', { className: 'loading-spinner' }),
                    React.createElement('p', null, 'Cargando sistema...')
                );
            }

            if (!state.user) {
                return React.createElement(LoginScreen, { onLogin: handleLogin });
            }

            const stats = {
                totalProductos: state.inventory.length,
                totalUnidades: state.inventory.reduce((sum, item) => sum + item.stock, 0),
                stockBajo: state.inventory.filter(item => item.stock > 0 && item.stock <= item.stockMinimo).length,
                movimientosHoy: state.history.filter(h => 
                    new Date(h.fecha).toDateString() === new Date().toDateString()
                ).length
            };

            return React.createElement('div', { className: 'app-container' },
                React.createElement('header', { className: 'header' },
                    React.createElement('div', { className: 'header-left' },
                        React.createElement('h1', null, 'Sistema de Inventario IT'),
                        React.createElement('div', { className: 'user-badges' },
                            React.createElement('span', {
                                className: `user-badge ${state.isAdmin ? 'admin' : 'technician'}`
                            }, state.isAdmin ? 'ðŸ‘‘ Admin' : 'ðŸ‘¤ TÃ©cnico', ': ', state.user.name)
                        )
                    ),
                    React.createElement('div', { className: 'header-stats' },
                        React.createElement('div', { className: 'stat-item' },
                            React.createElement('div', { className: 'stat-label' }, 'Productos'),
                            React.createElement('div', { className: 'stat-value blue' }, stats.totalProductos)
                        ),
                        React.createElement('div', { className: 'stat-item' },
                            React.createElement('div', { className: 'stat-label' }, 'Unidades'),
                            React.createElement('div', { className: 'stat-value green' }, stats.totalUnidades)
                        ),
                        React.createElement('div', { className: 'stat-item' },
                            React.createElement('div', { className: 'stat-label' }, 'Stock Bajo'),
                            React.createElement('div', { className: 'stat-value orange' }, stats.stockBajo)
                        ),
                        React.createElement('button', {
                            className: 'button button-secondary',
                            onClick: handleLogout
                        }, 'ðŸšª Salir')
                    )
                ),

                React.createElement('nav', { className: 'nav-tabs' },
                    ['dashboard', 'inventario', 'historial'].map(tab =>
                        React.createElement('button', {
                            key: tab,
                            className: `tab-button ${state.activeTab === tab ? 'active' : ''}`,
                            onClick: () => setState({ ...state, activeTab: tab })
                        },
                            tab === 'dashboard' ? 'ðŸ“Š' : tab === 'inventario' ? 'ðŸ“‹' : 'ðŸ“œ',
                            ' ',
                            tab.charAt(0).toUpperCase() + tab.slice(1)
                        )
                    ),
                    state.isAdmin && React.createElement('button', {
                        className: `tab-button ${state.activeTab === 'tecnicos' ? 'active' : ''}`,
                        onClick: () => setState({ ...state, activeTab: 'tecnicos' })
                    }, 'ðŸ‘¥ TÃ©cnicos')
                ),

                React.createElement('div', { className: 'content-section' },
                    state.activeTab === 'dashboard' && React.createElement(Dashboard, { state }),
                    state.activeTab === 'inventario' && React.createElement(InventoryView, { state, onRefresh: initializeApp }),
                    (state.activeTab === 'historial' || state.activeTab === 'tecnicos') && 
                        React.createElement('div', { className: 'empty-state' },
                            React.createElement('div', { className: 'empty-state-icon' }, 'ðŸš§'),
                            React.createElement('div', { className: 'empty-state-title' }, 'SecciÃ³n en desarrollo'),
                            React.createElement('div', { className: 'empty-state-text' }, 'Esta funcionalidad estarÃ¡ disponible prÃ³ximamente')
                        )
                )
            );
        }

        // ==========================================
        // RENDER APP
        // ==========================================
        
        ReactDOM.render(
            React.createElement(App),
            document.getElementById('root')
        );
    </script>
</body>
</html>
