<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Inventario IT - Sanlucar</title>
    <script src="https://alcdn.msauth.net/browser/2.38.1/js/msal-browser.min.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.8.4/dist/quagga.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0e14;
            --bg-secondary: #151a23;
            --bg-tertiary: #1e252f;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --accent-green: #3fb950;
            --accent-blue: #58a6ff;
            --accent-orange: #f97316;
            --accent-red: #ef4444;
            --accent-purple: #a855f7;
            --accent-yellow: #fbbf24;
            --border: #30363d;
            --shadow: rgba(0, 0, 0, 0.5);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, #0d1117 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            animation: fadeIn 0.5s ease;
        }

        .login-box {
            background: var(--bg-secondary);
            padding: 60px 50px;
            border-radius: 20px;
            border: 1px solid var(--border);
            box-shadow: 0 20px 60px var(--shadow);
            text-align: center;
            max-width: 500px;
            width: 100%;
        }

        .login-box h1 {
            font-size: 32px;
            margin-bottom: 16px;
        }

        .login-box h1::before {
            content: "ðŸ“¦";
            display: block;
            font-size: 64px;
            margin-bottom: 16px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .login-box p {
            color: var(--text-secondary);
            margin-bottom: 32px;
            line-height: 1.6;
        }

        .button {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
            white-space: nowrap;
        }

        .button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px var(--shadow);
        }

        .button:active:not(:disabled) {
            transform: translateY(0);
        }

        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .button-primary { background: var(--accent-blue); color: white; }
        .button-success { background: var(--accent-green); color: white; }
        .button-warning { background: var(--accent-orange); color: white; }
        .button-danger { background: var(--accent-red); color: white; }
        .button-purple { background: var(--accent-purple); color: white; }
        .button-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 400px;
        }

        .toast {
            background: var(--bg-secondary);
            border: 2px solid;
            border-radius: 12px;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 8px 24px var(--shadow);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .toast.success { border-color: var(--accent-green); background: rgba(63, 185, 80, 0.1); }
        .toast.error { border-color: var(--accent-red); background: rgba(239, 68, 68, 0.1); }
        .toast.warning { border-color: var(--accent-orange); background: rgba(249, 115, 22, 0.1); }

        .toast .icon { font-size: 20px; }
        .toast .text { flex: 1; font-size: 14px; font-weight: 600; }
        .toast.success .text { color: var(--accent-green); }
        .toast.error .text { color: var(--accent-red); }
        .toast.warning .text { color: var(--accent-orange); }

        .app-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            animation: fadeIn 0.5s ease;
        }

        .header {
            background: var(--bg-secondary);
            padding: 24px 32px;
            border-radius: 16px;
            margin-bottom: 24px;
            border: 1px solid var(--border);
            box-shadow: 0 8px 24px var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .header-left {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header h1::before {
            content: "ðŸ“¦";
            font-size: 32px;
        }

        .user-badges {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .user-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            font-size: 13px;
            border: 1px solid var(--border);
        }

        .user-badge.admin {
            background: rgba(168, 85, 247, 0.1);
            border-color: var(--accent-purple);
            color: var(--accent-purple);
        }

        .user-badge.technician {
            background: rgba(88, 166, 255, 0.1);
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        .header-stats {
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            font-family: 'IBM Plex Mono', monospace;
            margin-top: 4px;
        }

        .stat-value.green { color: var(--accent-green); }
        .stat-value.orange { color: var(--accent-orange); }
        .stat-value.blue { color: var(--accent-blue); }
        .stat-value.purple { color: var(--accent-purple); }

        .nav-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .tab-button {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-button:hover:not(:disabled) {
            background: var(--bg-tertiary);
            border-color: var(--accent-blue);
            transform: translateY(-2px);
        }

        .tab-button.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }

        .tab-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .content-section {
            background: var(--bg-secondary);
            padding: 32px;
            border-radius: 16px;
            border: 1px solid var(--border);
            box-shadow: 0 8px 24px var(--shadow);
            min-height: 500px;
        }

        .toolbar {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            align-items: center;
        }

        .toolbar-left {
            flex: 1;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            min-width: 250px;
        }

        .toolbar-right {
            display: flex;
            gap: 12px;
        }

        .search-bar {
            flex: 1;
            min-width: 250px;
            padding: 12px 16px 12px 40px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.2s ease;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%238b949e' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='m21 21-4.35-4.35'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: 12px center;
        }

        .search-bar:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 4px rgba(88, 166, 255, 0.1);
        }

        .filter-select {
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            min-width: 150px;
            cursor: pointer;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }

        .dashboard-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            transition: all 0.2s ease;
        }

        .dashboard-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px var(--shadow);
        }

        .dashboard-card h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 16px;
            margin-top: 24px;
        }

        .inventory-card {
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .inventory-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--accent-blue);
        }

        .inventory-card.low-stock::before { background: var(--accent-orange); }
        .inventory-card.out-of-stock::before { background: var(--accent-red); }

        .inventory-card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-4px);
            box-shadow: 0 8px 24px var(--shadow);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .card-category {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .card-barcode {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 12px;
            color: var(--accent-blue);
            background: var(--bg-primary);
            padding: 4px 8px;
            border-radius: 4px;
        }

        .card-info {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 16px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .info-label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .info-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .stock-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            font-family: 'IBM Plex Mono', monospace;
        }

        .stock-badge.available {
            background: rgba(63, 185, 80, 0.15);
            color: var(--accent-green);
        }

        .stock-badge.low {
            background: rgba(249, 115, 22, 0.15);
            color: var(--accent-orange);
        }

        .stock-badge.out {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
        }

        .card-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
            flex-wrap: wrap;
        }

        .card-actions .button {
            flex: 1;
            padding: 10px;
            font-size: 13px;
            min-width: 100px;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 24px;
            display: block;
            overflow-x: auto;
        }

        .history-table thead,
        .history-table tbody,
        .history-table tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }

        .history-table tbody {
            display: block;
            max-height: 600px;
            overflow-y: auto;
        }

        .history-table th {
            text-align: left;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .history-table td {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }

        .history-table tr:hover {
            background: var(--bg-tertiary);
        }

        .movement-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .movement-badge.Entrada {
            background: rgba(63, 185, 80, 0.15);
            color: var(--accent-green);
        }

        .movement-badge.Salida {
            background: rgba(88, 166, 255, 0.15);
            color: var(--accent-blue);
        }

        .movement-badge.Devolucion {
            background: rgba(249, 115, 22, 0.15);
            color: var(--accent-orange);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .empty-state-text {
            font-size: 14px;
        }

        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            gap: 16px;
        }

        .loading-state .loading-spinner {
            width: 40px;
            height: 40px;
            border-width: 4px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            animation: fadeIn 0.2s ease;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: 16px;
            border: 1px solid var(--border);
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px var(--shadow);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            padding: 24px 32px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            z-index: 10;
        }

        .modal-title {
            font-size: 22px;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
            line-height: 1;
            transition: all 0.2s ease;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }

        .modal-close:hover {
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }

        .modal-body {
            padding: 32px;
        }

        .modal-footer {
            padding: 24px 32px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            position: sticky;
            bottom: 0;
            background: var(--bg-secondary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 15px;
            transition: all 0.2s ease;
            font-family: 'Inter', sans-serif;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 4px rgba(88, 166, 255, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }

        .scanner-input {
            width: 100%;
            padding: 20px;
            background: var(--bg-primary);
            border: 3px dashed var(--accent-blue);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 18px;
            font-family: 'IBM Plex Mono', monospace;
            margin-bottom: 24px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .scanner-input:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 0 6px rgba(63, 185, 80, 0.2);
            animation: pulse 0.5s ease;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .signature-container {
            margin-top: 24px;
            padding: 20px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            border: 2px solid var(--border);
        }

        .signature-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .signature-canvas {
            width: 100%;
            height: 200px;
            background: var(--bg-primary);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: crosshair;
            touch-action: none;
            display: block;
        }

        .signature-actions {
            display: flex;
            gap: 12px;
            margin-top: 12px;
        }

        .required-asterisk {
            color: var(--accent-red);
        }

        .alert-banner {
            background: rgba(249, 115, 22, 0.1);
            border: 2px solid var(--accent-orange);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .alert-icon {
            font-size: 24px;
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--accent-orange);
            margin-bottom: 4px;
        }

        .alert-message {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .signature-preview {
            max-width: 150px;
            max-height: 80px;
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .signature-preview:hover {
            transform: scale(2);
            z-index: 1000;
        }

        .action-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            font-size: 16px;
        }

        .action-icon:hover {
            transform: translateY(-2px);
            border-color: var(--accent-blue);
        }

        .action-icon.danger:hover {
            border-color: var(--accent-red);
            color: var(--accent-red);
        }

        @media (max-width: 768px) {
            .app-container { padding: 12px; }
            .header { padding: 20px; }
            .header h1 { font-size: 22px; }
            .inventory-grid { grid-template-columns: 1fr; }
            .dashboard-grid { grid-template-columns: 1fr; }
            .form-row { grid-template-columns: 1fr; }
            .toolbar { flex-direction: column; }
            .toolbar-left, .toolbar-right { width: 100%; }
            .content-section { padding: 20px; }
            .modal { margin: 0; max-height: 100vh; border-radius: 0; }
        }

        /* Barcode Scanner Styles */
        .scanner-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 99999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
            padding: 20px;
        }

        .scanner-container {
            width: 100%;
            max-width: 640px;
            position: relative;
            background: var(--bg-primary);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 60px var(--shadow);
        }

        .scanner-header {
            padding: 20px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .scanner-title {
            font-size: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .scanner-viewport {
            position: relative;
            width: 100%;
            height: 400px;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #scanner-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }

        .scanner-line {
            position: absolute;
            top: 50%;
            left: 10%;
            right: 10%;
            height: 2px;
            background: var(--accent-green);
            box-shadow: 0 0 10px var(--accent-green);
            transform: translateY(-50%);
            animation: scanLine 2s ease-in-out infinite;
        }

        @keyframes scanLine {
            0%, 100% { opacity: 0.5; transform: translateY(-50%) scaleX(0.8); }
            50% { opacity: 1; transform: translateY(-50%) scaleX(1); }
        }

        .scanner-corners {
            position: absolute;
            top: 20%;
            left: 10%;
            right: 10%;
            bottom: 20%;
            border: 2px solid var(--accent-blue);
            border-radius: 12px;
        }

        .scanner-corners::before,
        .scanner-corners::after {
            content: '';
            position: absolute;
            width: 30px;
            height: 30px;
            border: 3px solid var(--accent-blue);
        }

        .scanner-corners::before {
            top: -3px;
            left: -3px;
            border-right: none;
            border-bottom: none;
            border-top-left-radius: 12px;
        }

        .scanner-corners::after {
            bottom: -3px;
            right: -3px;
            border-left: none;
            border-top: none;
            border-bottom-right-radius: 12px;
        }

        .scanner-info {
            padding: 24px;
            text-align: center;
            background: var(--bg-secondary);
        }

        .scanner-instruction {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .scanner-result {
            font-size: 18px;
            font-weight: 700;
            color: var(--accent-green);
            font-family: 'IBM Plex Mono', monospace;
            padding: 12px;
            background: rgba(63, 185, 80, 0.1);
            border-radius: 8px;
            margin-top: 12px;
        }

        .scanner-error {
            color: var(--accent-red);
            background: rgba(239, 68, 68, 0.1);
        }

        .scanner-button {
            padding: 10px 20px;
            background: var(--accent-blue);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .scanner-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .scanner-button-icon {
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div id="toast-container" class="toast-container"></div>
    <div id="root"></div>

    <script>
        // ==========================================
        // CONFIGURACIÃ“N GLOBAL
        // ==========================================
        
        const CONFIG = {
            sharepoint: {
                sitePath: 'sanlucarfruit.sharepoint.com:/sites/InformationSystems',
                lists: {
                    inventario: 'StockControl_InventarioIT',
                    tecnicos: 'StockControl_TecnicosIT',
                    historial: 'StockControl_HistorialIT',
                    admins: 'StockControl_Admins',
                    asignaciones: 'StockControl_Asignaciones'
                }
            },
            msal: {
                clientId: '80ba264e-e1fc-4749-bf00-2c25b93b4ee5',
                authority: 'https://login.microsoftonline.com/f37778d8-59b2-4e5e-a56b-08eb8ad3c13a',
                redirectUri: window.location.href.split('?')[0].split('#')[0]
            },
            scopes: ['User.Read', 'Sites.ReadWrite.All']
        };

        let msalInstance;
        let graphClient;
        let dataManager;

        // ==========================================
        // MICROSOFT GRAPH API CLIENT
        // ==========================================
        
        class GraphAPIClient {
            constructor(accessToken) {
                this.accessToken = accessToken;
                this.baseUrl = 'https://graph.microsoft.com/v1.0';
            }

            async request(endpoint, options = {}) {
                const url = `${this.baseUrl}${endpoint}`;
                const headers = {
                    'Authorization': `Bearer ${this.accessToken}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                };

                try {
                    const response = await fetch(url, {
                        ...options,
                        headers
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error?.message || `HTTP ${response.status}`);
                    }

                    if (response.status === 204) {
                        return null;
                    }

                    return await response.json();
                } catch (error) {
                    console.error('Graph API Error:', error);
                    throw error;
                }
            }

            async getListItems(listName) {
                const endpoint = `/sites/${CONFIG.sharepoint.sitePath}:/lists/${listName}/items?expand=fields&$top=5000`;
                const result = await this.request(endpoint);
                return result.value.map(item => ({ ...item.fields, sharePointId: item.id }));
            }

            async createListItem(listName, data) {
                const endpoint = `/sites/${CONFIG.sharepoint.sitePath}:/lists/${listName}/items`;
                const result = await this.request(endpoint, {
                    method: 'POST',
                    body: JSON.stringify({ fields: data })
                });
                return { ...result.fields, sharePointId: result.id };
            }

            async updateListItem(listName, itemId, data) {
                const endpoint = `/sites/${CONFIG.sharepoint.sitePath}:/lists/${listName}/items/${itemId}/fields`;
                await this.request(endpoint, {
                    method: 'PATCH',
                    body: JSON.stringify(data)
                });
                return true;
            }

            async deleteListItem(listName, itemId) {
                const endpoint = `/sites/${CONFIG.sharepoint.sitePath}:/lists/${listName}/items/${itemId}`;
                await this.request(endpoint, { method: 'DELETE' });
                return true;
            }

            async getCurrentUser() {
                return await this.request('/me');
            }
        }

        // ==========================================
        // DATA MANAGER
        // ==========================================
        
        class DataManager {
            constructor(graphClient) {
                this.graph = graphClient;
            }

            async loadAllData() {
                try {
                    const [inventario, tecnicos, historial, admins, asignaciones] = await Promise.all([
                        this.graph.getListItems(CONFIG.sharepoint.lists.inventario),
                        this.graph.getListItems(CONFIG.sharepoint.lists.tecnicos),
                        this.graph.getListItems(CONFIG.sharepoint.lists.historial),
                        this.graph.getListItems(CONFIG.sharepoint.lists.admins),
                        this.graph.getListItems(CONFIG.sharepoint.lists.asignaciones).catch(() => [])
                    ]);

                    return {
                        inventory: inventario.map(item => ({
                            id: item.sharePointId,
                            nombre: item.Nombre || item.Title,
                            categoria: item.Categoria,
                            barcode: item.CodigoBarras,
                            stock: parseInt(item.Stock) || 0,
                            stockMinimo: parseInt(item.StockMinimo) || 0,
                            ubicacion: item.Ubicacion || ''
                        })),
                        technicians: tecnicos.map(item => ({
                            id: item.sharePointId,
                            nombre: item.NombreTecnico || item.Title,
                            codigo: item.CodigoTecnico,
                            email: item.Email,
                            activo: item.Activo === true || item.Activo === 'Yes'
                        })),
                        history: historial.map(item => ({
                            id: item.sharePointId,
                            fecha: item.FechaHora || item.Created,
                            tipo: item.TipoMovimiento,
                            producto: item.Producto,
                            cantidad: parseInt(item.Cantidad) || 0,
                            ticket: item.Ticket || '',
                            usuario: item.Usuario || '',
                            tecnico: item.Tecnico || '',
                            firma: item.Firma || null
                        })).sort((a, b) => new Date(b.fecha) - new Date(a.fecha)),
                        assignments: asignaciones.map(item => ({
                            id: item.sharePointId,
                            nombreEmpleado: item.NombreEmpleado,
                            emailEmpleado: item.EmailEmpleado,
                            departamento: item.Departamento,
                            puesto: item.Puesto,
                            fechaIncorporacion: item.FechaIncorporacion,
                            productosAsignados: JSON.parse(item.ProductosAsignados || '[]'),
                            cantidadProductos: parseInt(item.CantidadProductos) || 0,
                            firmaEmpleado: item.FirmaEmpleado,
                            tecnicoResponsable: item.TecnicoResponsable,
                            fechaAsignacion: item.FechaAsignacion,
                            estado: item.Estado,
                            observaciones: item.Observaciones || ''
                        })).sort((a, b) => new Date(b.fechaAsignacion) - new Date(a.fechaAsignacion)),
                        admins: admins
                    };
                } catch (error) {
                    console.error('Error cargando datos:', error);
                    throw error;
                }
            }

            async createInventoryItem(data) {
                return await this.graph.createListItem(CONFIG.sharepoint.lists.inventario, {
                    Title: data.nombre,
                    Nombre: data.nombre,
                    Categoria: data.categoria,
                    CodigoBarras: data.barcode,
                    Stock: data.stock,
                    StockMinimo: data.stockMinimo,
                    Ubicacion: data.ubicacion
                });
            }

            async updateInventoryItem(itemId, data) {
                await this.graph.updateListItem(CONFIG.sharepoint.lists.inventario, itemId, data);
            }

            async deleteInventoryItem(itemId) {
                await this.graph.deleteListItem(CONFIG.sharepoint.lists.inventario, itemId);
            }

            async addToHistory(data) {
                await this.graph.createListItem(CONFIG.sharepoint.lists.historial, {
                    Title: `${data.tipo} - ${data.producto}`,
                    TipoMovimiento: data.tipo,
                    Producto: data.producto,
                    Cantidad: data.cantidad,
                    Ticket: data.ticket || '',
                    Usuario: data.usuario || '',
                    Tecnico: data.tecnico || '',
                    FechaHora: new Date().toISOString(),
                    Firma: data.firma || ''
                });
            }

            async createTechnician(data) {
                return await this.graph.createListItem(CONFIG.sharepoint.lists.tecnicos, {
                    Title: data.nombre,
                    NombreTecnico: data.nombre,
                    CodigoTecnico: data.codigo,
                    Email: data.email,
                    Activo: true
                });
            }

            async toggleTechnicianStatus(itemId, currentStatus) {
                await this.graph.updateListItem(CONFIG.sharepoint.lists.tecnicos, itemId, {
                    Activo: !currentStatus
                });
            }

            async deleteHistoryItem(itemId) {
                await this.graph.deleteListItem(CONFIG.sharepoint.lists.historial, itemId);
            }

            async createAssignment(data) {
                return await this.graph.createListItem(CONFIG.sharepoint.lists.asignaciones, {
                    Title: `AsignaciÃ³n - ${data.nombreEmpleado} - ${new Date().toLocaleDateString('es-ES')}`,
                    NombreEmpleado: data.nombreEmpleado,
                    EmailEmpleado: data.emailEmpleado,
                    Departamento: data.departamento,
                    Puesto: data.puesto,
                    FechaIncorporacion: data.fechaIncorporacion,
                    ProductosAsignados: JSON.stringify(data.productosAsignados),
                    CantidadProductos: data.productosAsignados.length,
                    FirmaEmpleado: data.firmaEmpleado,
                    TecnicoResponsable: data.tecnicoResponsable,
                    FechaAsignacion: new Date().toISOString(),
                    Estado: 'Activo',
                    Observaciones: data.observaciones || ''
                });
            }

            async updateAssignmentStatus(itemId, nuevoEstado) {
                await this.graph.updateListItem(CONFIG.sharepoint.lists.asignaciones, itemId, {
                    Estado: nuevoEstado
                });
            }

            async deleteAssignment(itemId) {
                await this.graph.deleteListItem(CONFIG.sharepoint.lists.asignaciones, itemId);
            }
        }

        // ==========================================
        // UTILITY FUNCTIONS
        // ==========================================
        
        async function initializeMSAL() {
            try {
                msalInstance = new msal.PublicClientApplication({
                    auth: CONFIG.msal,
                    cache: { cacheLocation: 'localStorage', storeAuthStateInCookie: false }
                });
                await msalInstance.initialize();
                return true;
            } catch (error) {
                console.error('Error inicializando MSAL:', error);
                return false;
            }
        }

        async function getAccessToken() {
            const accounts = msalInstance.getAllAccounts();
            if (accounts.length === 0) return null;

            try {
                const response = await msalInstance.acquireTokenSilent({
                    scopes: CONFIG.scopes,
                    account: accounts[0]
                });
                return response.accessToken;
            } catch (error) {
                console.error('Error obteniendo token:', error);
                return null;
            }
        }

        async function login() {
            try {
                const response = await msalInstance.loginPopup({ scopes: CONFIG.scopes });
                msalInstance.setActiveAccount(response.account);
                return {
                    name: response.account.name,
                    email: response.account.username,
                    token: response.accessToken
                };
            } catch (error) {
                console.error('Error en login:', error);
                throw error;
            }
        }

        async function logout() {
            try {
                await msalInstance.logoutPopup();
            } catch (error) {
                console.error('Error en logout:', error);
            }
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = { success: 'âœ“', error: 'âœ—', warning: 'âš ' };
            toast.innerHTML = `
                <span class="icon">${icons[type] || 'â€¢'}</span>
                <span class="text">${message}</span>
            `;
            
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        function exportToCSV(data, filename) {
            if (!data || data.length === 0) {
                showToast('No hay datos para exportar', 'warning');
                return;
            }
            
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(field => {
                    let value = row[field] || '';
                    if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                        value = `"${value.replace(/"/g, '""')}"`;
                    }
                    return value;
                }).join(','))
            ].join('\n');

            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${filename}_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showToast('Archivo exportado correctamente', 'success');
        }

        function generateBarcode(code) {
            const canvas = document.createElement('canvas');
            JsBarcode(canvas, code, {
                format: 'CODE128',
                width: 2,
                height: 100,
                displayValue: true
            });
            return canvas.toDataURL('image/png');
        }

        function printTechnicianCard(tech) {
            const printWindow = window.open('', '_blank');
            const barcodeImage = generateBarcode(tech.codigo);
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Tarjeta de TÃ©cnico - ${tech.nombre}</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            min-height: 100vh;
                            margin: 0;
                            background: #f0f0f0;
                        }
                        .card {
                            background: white;
                            padding: 40px;
                            border-radius: 12px;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                            text-align: center;
                            max-width: 400px;
                        }
                        h1 {
                            color: #333;
                            margin-bottom: 10px;
                            font-size: 24px;
                        }
                        .codigo {
                            color: #666;
                            font-size: 18px;
                            font-weight: bold;
                            margin-bottom: 20px;
                        }
                        .email {
                            color: #999;
                            font-size: 14px;
                            margin-bottom: 30px;
                        }
                        img {
                            max-width: 100%;
                            height: auto;
                        }
                        .footer {
                            margin-top: 30px;
                            padding-top: 20px;
                            border-top: 2px solid #eee;
                            color: #999;
                            font-size: 12px;
                        }
                        @media print {
                            body { background: white; }
                            .card { box-shadow: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="card">
                        <h1>${tech.nombre}</h1>
                        <div class="codigo">CÃ³digo: ${tech.codigo}</div>
                        <div class="email">${tech.email}</div>
                        <img src="${barcodeImage}" alt="CÃ³digo de barras">
                        <div class="footer">
                            Sistema de Inventario IT<br>
                            Escanea este cÃ³digo para identificarte
                        </div>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            setTimeout(() => printWindow.print(), 250);
        }

        // ==========================================
        // BARCODE SCANNER
        // ==========================================
        
        let scannerActive = false;
        let scannerCallback = null;

        function startBarcodeScanner(callback) {
            if (typeof Quagga === 'undefined') {
                showToast('EscÃ¡ner no disponible', 'error');
                return;
            }

            scannerCallback = callback;
            
            // Crear modal del escÃ¡ner
            const modal = document.createElement('div');
            modal.id = 'barcode-scanner-modal';
            modal.className = 'scanner-modal';
            modal.innerHTML = `
                <div class="scanner-container" onclick="event.stopPropagation()">
                    <div class="scanner-header">
                        <div class="scanner-title">
                            ðŸ“· EscÃ¡ner de CÃ³digo de Barras
                        </div>
                        <button class="modal-close" id="scanner-close-btn">Ã—</button>
                    </div>
                    <div class="scanner-viewport" id="scanner-viewport">
                        <div class="scanner-overlay">
                            <div class="scanner-corners"></div>
                            <div class="scanner-line"></div>
                        </div>
                    </div>
                    <div class="scanner-info">
                        <div class="scanner-instruction">
                            Enfoca el cÃ³digo de barras dentro del recuadro
                        </div>
                        <div id="scanner-status">Iniciando cÃ¡mara...</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Event listener para cerrar al hacer click fuera
            modal.addEventListener('click', stopBarcodeScanner);
            
            // Event listener para el botÃ³n cerrar
            const closeBtn = document.getElementById('scanner-close-btn');
            if (closeBtn) {
                closeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    stopBarcodeScanner();
                });
            }
            
            // Inicializar Quagga
            setTimeout(() => {
                Quagga.init({
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: document.querySelector('#scanner-viewport'),
                        constraints: {
                            facingMode: "environment",
                            width: { min: 640 },
                            height: { min: 480 }
                        }
                    },
                    decoder: {
                        readers: [
                            "code_128_reader",
                            "ean_reader",
                            "ean_8_reader",
                            "code_39_reader",
                            "code_39_vin_reader",
                            "upc_reader",
                            "upc_e_reader"
                        ],
                        debug: {
                            drawBoundingBox: true,
                            showFrequency: true,
                            drawScanline: true,
                            showPattern: true
                        }
                    },
                    locator: {
                        patchSize: "medium",
                        halfSample: true
                    },
                    numOfWorkers: 2,
                    frequency: 10
                }, function(err) {
                    const statusEl = document.getElementById('scanner-status');
                    
                    if (err) {
                        console.error('Scanner init error:', err);
                        if (statusEl) {
                            statusEl.innerHTML = '<div class="scanner-result scanner-error">âš ï¸ Error: ' + (err.message || 'No se pudo acceder a la cÃ¡mara') + '</div>';
                        }
                        return;
                    }
                    
                    if (statusEl) {
                        statusEl.innerHTML = '<div class="scanner-instruction" style="color: var(--accent-green);">âœ“ CÃ¡mara lista - Escanea tu cÃ³digo de barras</div>';
                    }
                    
                    console.log("âœ“ Scanner initialized");
                    Quagga.start();
                    scannerActive = true;
                });

                // Detectar cÃ³digos
                Quagga.onDetected(function(result) {
                    if (!scannerActive) return;
                    
                    const code = result.codeResult.code;
                    console.log("âœ“ Barcode detected:", code);
                    
                    // Mostrar resultado
                    const statusEl = document.getElementById('scanner-status');
                    if (statusEl) {
                        statusEl.innerHTML = '<div class="scanner-result">âœ“ CÃ³digo detectado: ' + code + '</div>';
                    }
                    
                    // Sonido de confirmaciÃ³n
                    try {
                        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZSA0PVqzn77BdGAg+ltryy3gvBSh+zPLaizsIGGS57OihUBELTKXh8bllHAU2jdXzzn0vBSt8yvHaizwJF2K37OmmUxELTKXh8bllHAU2jdXzzn0vBSt8yvHaizwJF2K37OmmUxELTKXh8bllHAU2jdXzzn0vBSt8yvHaizwJF2K37OmmUxELTKXh8bllHAU2jdXzzn0vBSt8yvHaizwJF2K37OmmUxELTKXh8bllHAU2jdXzzn0vBSt8yvHaizwJF2K37OmmUxELTKXh8bllHAU2jdXzzn0vBSt8yvHaizwJF2K37OmmUxELTKXh8bllHAU2jdXzzn0vBSt8yvHaizwJF2K37OmmUxELTKXh8bllHAU2jdXzzn0vBSt8yvHaizwJF2K37OmmUxELTKXh8bllHAU2jdXzzn0vBSt8yvHaizwJF2K37OmmUxELTKXh8bllHAU2jdXzzn0vBSt8yvHaizwJF2K37OmmUxELTKXh8bllHAU2jdXzzn0vBSt8yvHaizwJF2K37OmmUxELTKXh8bllHAU2jdXzzn0vBSt8yvHaizwJF2K37OmmUxELTKXh8bllHAU2jdXzzn0vBSt8yvHaizwJF2K37OmmU=');
                        audio.play().catch(e => console.log('Audio play blocked'));
                    } catch (e) {
                        console.log('Audio not available');
                    }
                    
                    // VibraciÃ³n en dispositivos mÃ³viles
                    if (navigator.vibrate) {
                        navigator.vibrate(200);
                    }
                    
                    // Ejecutar callback despuÃ©s de un breve delay
                    setTimeout(() => {
                        if (scannerCallback) {
                            scannerCallback(code);
                        }
                        stopBarcodeScanner();
                    }, 500);
                });
            }, 100);
        }

        function stopBarcodeScanner() {
            if (scannerActive) {
                Quagga.stop();
                scannerActive = false;
            }
            
            const modal = document.getElementById('barcode-scanner-modal');
            if (modal) {
                modal.remove();
            }
            
            scannerCallback = null;
        }

        // ==========================================
        // REACT COMPONENTS
        // ==========================================
        
        // Esperar a que React estÃ© disponible
        window.addEventListener('load', function() {
            if (typeof React === 'undefined' || typeof ReactDOM === 'undefined') {
                document.getElementById('root').innerHTML = '<div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px;"><div style="max-width: 500px; text-align: center; color: white;"><h1 style="font-size: 24px; margin-bottom: 16px;">âš ï¸ Error</h1><p style="color: #8b949e;">React no se pudo cargar. Recarga la pÃ¡gina.</p></div></div>';
                return;
            }

        const { useState, useEffect, useRef, createElement: e } = React;

        function LoginScreen({ onLogin }) {
            const [loading, setLoading] = useState(false);

            const handleLogin = async () => {
                setLoading(true);
                try {
                    await onLogin();
                } catch (error) {
                    showToast('Error al iniciar sesiÃ³n', 'error');
                } finally {
                    setLoading(false);
                }
            };

            return e('div', { className: 'login-screen' },
                e('div', { className: 'login-box' },
                    e('h1', null, 'Sistema de Inventario IT'),
                    e('p', { style: { fontSize: '14px', color: 'var(--accent-purple)', fontWeight: '600', marginBottom: '12px' } },
                        'Sanlucar Fruit'
                    ),
                    e('p', null,
                        'Inicia sesiÃ³n con tu cuenta corporativa de Microsoft 365 para acceder al sistema de gestiÃ³n de inventario.'
                    ),
                    e('button', {
                        className: 'button button-primary',
                        onClick: handleLogin,
                        disabled: loading,
                        style: { width: '100%', marginTop: '16px' }
                    },
                        loading ? e('span', { className: 'loading-spinner' }) : 'ðŸ”',
                        loading ? ' Iniciando sesiÃ³n...' : ' Iniciar SesiÃ³n con Microsoft'
                    ),
                    e('p', { style: { fontSize: '12px', marginTop: '24px' } },
                        'ðŸ’¡ Usa tu cuenta @sanlucar.com'
                    )
                )
            );
        }

        function Dashboard({ state }) {
            const stats = {
                totalProductos: state.inventory.length,
                totalUnidades: state.inventory.reduce((sum, item) => sum + item.stock, 0),
                stockBajo: state.inventory.filter(item => item.stock > 0 && item.stock <= item.stockMinimo).length,
                sinStock: state.inventory.filter(item => item.stock === 0).length,
                movimientosHoy: state.history.filter(h => 
                    new Date(h.fecha).toDateString() === new Date().toDateString()
                ).length,
                tecnicosActivos: state.technicians.filter(t => t.activo).length
            };

            return e('div', null,
                e('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px', flexWrap: 'wrap', gap: '16px' } },
                    e('h2', { style: { fontSize: '24px', fontWeight: '700' } }, 'ðŸ“Š Dashboard'),
                    e('button', {
                        className: 'button button-success',
                        onClick: () => exportToCSV(state.inventory, 'inventario_completo')
                    }, 'ðŸ“¥ Exportar Inventario')
                ),
                
                e('div', { className: 'dashboard-grid' },
                    e('div', { className: 'dashboard-card' },
                        e('h3', null, 'ðŸ“¦ Resumen de Stock'),
                        e('div', { style: { display: 'flex', flexDirection: 'column', gap: '12px' } },
                            [
                                { label: 'Total Productos', value: stats.totalProductos, color: 'var(--accent-blue)' },
                                { label: 'Total Unidades', value: stats.totalUnidades, color: 'var(--accent-green)' },
                                { label: 'Stock Bajo', value: stats.stockBajo, color: 'var(--accent-orange)' },
                                { label: 'Sin Stock', value: stats.sinStock, color: 'var(--accent-red)' }
                            ].map((stat, idx) =>
                                e('div', {
                                    key: idx,
                                    style: { display: 'flex', justifyContent: 'space-between', padding: '12px', background: 'var(--bg-primary)', borderRadius: '8px' }
                                },
                                    e('span', { style: { color: 'var(--text-secondary)', fontSize: '14px' } }, stat.label),
                                    e('span', { style: { color: stat.color, fontSize: '18px', fontWeight: '700', fontFamily: 'IBM Plex Mono, monospace' } }, stat.value)
                                )
                            )
                        )
                    ),
                    
                    e('div', { className: 'dashboard-card' },
                        e('h3', null, 'ðŸ“ˆ Actividad'),
                        e('div', { style: { display: 'flex', flexDirection: 'column', gap: '12px' } },
                            [
                                { label: 'Movimientos Hoy', value: stats.movimientosHoy, color: 'var(--accent-purple)' },
                                { label: 'Total Movimientos', value: state.history.length, color: 'var(--accent-blue)' },
                                { label: 'TÃ©cnicos Activos', value: stats.tecnicosActivos, color: 'var(--accent-green)' }
                            ].map((stat, idx) =>
                                e('div', {
                                    key: idx,
                                    style: { display: 'flex', justifyContent: 'space-between', padding: '12px', background: 'var(--bg-primary)', borderRadius: '8px' }
                                },
                                    e('span', { style: { color: 'var(--text-secondary)', fontSize: '14px' } }, stat.label),
                                    e('span', { style: { color: stat.color, fontSize: '18px', fontWeight: '700', fontFamily: 'IBM Plex Mono, monospace' } }, stat.value)
                                )
                            )
                        )
                    ),
                    
                    e('div', { className: 'dashboard-card' },
                        e('h3', null, 'ðŸ† Top 5 Productos'),
                        e('div', { style: { display: 'flex', flexDirection: 'column', gap: '8px' } },
                            state.inventory
                                .map(item => ({
                                    ...item,
                                    count: state.history.filter(h => h.producto === item.nombre && h.tipo === 'Salida').length
                                }))
                                .sort((a, b) => b.count - a.count)
                                .slice(0, 5)
                                .map((item, idx) =>
                                    e('div', {
                                        key: item.id,
                                        style: { display: 'flex', justifyContent: 'space-between', padding: '12px', background: 'var(--bg-primary)', borderRadius: '8px' }
                                    },
                                        e('span', { style: { color: 'var(--text-secondary)', fontSize: '14px' } }, `${idx + 1}. ${item.nombre}`),
                                        e('span', { style: { color: 'var(--accent-yellow)', fontSize: '18px', fontWeight: '700', fontFamily: 'IBM Plex Mono, monospace' } }, item.count)
                                    )
                                )
                        )
                    ),
                    
                    e('div', { className: 'dashboard-card' },
                        e('h3', null, 'âš ï¸ Productos CrÃ­ticos'),
                        state.inventory.filter(item => item.stock > 0 && item.stock <= item.stockMinimo).length > 0 ?
                            e('div', { style: { display: 'flex', flexDirection: 'column', gap: '8px' } },
                                state.inventory
                                    .filter(item => item.stock > 0 && item.stock <= item.stockMinimo)
                                    .slice(0, 5)
                                    .map(item =>
                                        e('div', {
                                            key: item.id,
                                            style: { display: 'flex', justifyContent: 'space-between', padding: '12px', background: 'var(--bg-primary)', borderRadius: '8px' }
                                        },
                                            e('span', { style: { color: 'var(--text-secondary)', fontSize: '14px' } }, item.nombre),
                                            e('span', { style: { color: 'var(--accent-orange)', fontSize: '18px', fontWeight: '700', fontFamily: 'IBM Plex Mono, monospace' } }, 
                                                `${item.stock}/${item.stockMinimo}`
                                            )
                                        )
                                    )
                            ) :
                            e('div', { style: { textAlign: 'center', padding: '20px', color: 'var(--text-secondary)' } },
                                'âœ“ Todo el stock estÃ¡ en niveles Ã³ptimos'
                            )
                    )
                )
            );
        }

        function InventoryView({ state, onRefresh, onOpenModal }) {
            const [search, setSearch] = useState('');
            const [filterCategory, setFilterCategory] = useState('all');

            const filtered = state.inventory.filter(item => {
                const matchesSearch = item.nombre.toLowerCase().includes(search.toLowerCase()) ||
                                    item.categoria.toLowerCase().includes(search.toLowerCase()) ||
                                    item.barcode.includes(search);
                const matchesCategory = filterCategory === 'all' || item.categoria === filterCategory;
                return matchesSearch && matchesCategory;
            });

            const categories = [...new Set(state.inventory.map(item => item.categoria))].filter(Boolean);

            return e('div', null,
                e('div', { className: 'toolbar' },
                    e('div', { className: 'toolbar-left' },
                        e('input', {
                            type: 'text',
                            className: 'search-bar',
                            placeholder: 'ðŸ” Buscar productos...',
                            value: search,
                            onChange: (ev) => setSearch(ev.target.value)
                        }),
                        e('button', {
                            className: 'button button-primary',
                            onClick: () => {
                                startBarcodeScanner((code) => {
                                    setSearch(code);
                                    showToast(`Buscando: ${code}`, 'success');
                                });
                            },
                            style: { padding: '12px 20px' }
                        }, 'ðŸ“· Escanear'),
                        e('select', {
                            className: 'filter-select',
                            value: filterCategory,
                            onChange: (ev) => setFilterCategory(ev.target.value)
                        },
                            e('option', { value: 'all' }, 'Todas las categorÃ­as'),
                            categories.map(cat =>
                                e('option', { key: cat, value: cat }, cat)
                            )
                        )
                    ),
                    e('div', { className: 'toolbar-right' },
                        e('button', {
                            className: 'button button-success',
                            onClick: () => onOpenModal('entrada', null)
                        }, 'âž• Nuevo Producto'),
                        e('button', {
                            className: 'button button-secondary',
                            onClick: () => exportToCSV(filtered, 'inventario')
                        }, 'ðŸ“¥ Exportar')
                    )
                ),
                
                filtered.length > 0 ?
                    e('div', { className: 'inventory-grid' },
                        filtered.map(item => {
                            const stockClass = item.stock === 0 ? 'out-of-stock' :
                                             item.stock <= item.stockMinimo ? 'low-stock' : '';
                            
                            return e('div', {
                                key: item.id,
                                className: `inventory-card ${stockClass}`
                            },
                                e('div', { className: 'card-header' },
                                    e('div', null,
                                        e('div', { className: 'card-title' }, item.nombre),
                                        e('div', { className: 'card-category' }, item.categoria)
                                    ),
                                    e('div', { className: 'card-barcode' }, item.barcode)
                                ),
                                
                                e('div', { className: 'card-info' },
                                    e('div', { className: 'info-row' },
                                        e('span', { className: 'info-label' }, 'Stock Actual'),
                                        e('span', {
                                            className: `stock-badge ${item.stock === 0 ? 'out' : item.stock <= item.stockMinimo ? 'low' : 'available'}`
                                        }, `${item.stock} unidades`)
                                    ),
                                    e('div', { className: 'info-row' },
                                        e('span', { className: 'info-label' }, 'Stock MÃ­nimo'),
                                        e('span', { className: 'info-value' }, item.stockMinimo)
                                    ),
                                    e('div', { className: 'info-row' },
                                        e('span', { className: 'info-label' }, 'UbicaciÃ³n'),
                                        e('span', { className: 'info-value' }, item.ubicacion || '-')
                                    )
                                ),

                                e('div', { className: 'card-actions' },
                                    e('button', {
                                        className: 'button button-primary',
                                        disabled: item.stock === 0,
                                        onClick: () => onOpenModal('salida', item)
                                    }, 'â¬†ï¸ Salida'),
                                    e('button', {
                                        className: 'button button-success',
                                        onClick: () => onOpenModal('entrada', item)
                                    }, 'â¬‡ï¸ Entrada'),
                                    e('button', {
                                        className: 'button button-secondary',
                                        onClick: () => onOpenModal('editar', item)
                                    }, 'âœï¸'),
                                    e('button', {
                                        className: 'button button-danger',
                                        onClick: () => onOpenModal('eliminar-producto', item)
                                    }, 'ðŸ—‘ï¸')
                                )
                            );
                        })
                    ) :
                    e('div', { className: 'empty-state' },
                        e('div', { className: 'empty-state-icon' }, 'ðŸ”'),
                        e('div', { className: 'empty-state-title' }, 'No se encontraron productos'),
                        e('div', { className: 'empty-state-text' }, 'Intenta con otros tÃ©rminos de bÃºsqueda')
                    )
            );
        }

        function HistoryView({ state, onRefresh, onOpenModal }) {
            const [search, setSearch] = useState('');
            const [filterType, setFilterType] = useState('all');
            const [filterDateFrom, setFilterDateFrom] = useState('');
            const [filterDateTo, setFilterDateTo] = useState('');

            const filtered = state.history.filter(entry => {
                const matchesSearch = entry.producto.toLowerCase().includes(search.toLowerCase()) ||
                                    entry.usuario.toLowerCase().includes(search.toLowerCase()) ||
                                    (entry.ticket && entry.ticket.toLowerCase().includes(search.toLowerCase()));
                const matchesType = filterType === 'all' || entry.tipo === filterType;
                
                let matchesDate = true;
                if (filterDateFrom || filterDateTo) {
                    const entryDate = new Date(entry.fecha);
                    if (filterDateFrom) matchesDate = entryDate >= new Date(filterDateFrom);
                    if (filterDateTo && matchesDate) matchesDate = entryDate <= new Date(filterDateTo + 'T23:59:59');
                }
                
                return matchesSearch && matchesType && matchesDate;
            });

            return e('div', null,
                e('div', { className: 'toolbar' },
                    e('div', { className: 'toolbar-left' },
                        e('input', {
                            type: 'text',
                            className: 'search-bar',
                            placeholder: 'ðŸ” Buscar en historial...',
                            value: search,
                            onChange: (ev) => setSearch(ev.target.value)
                        }),
                        e('select', {
                            className: 'filter-select',
                            value: filterType,
                            onChange: (ev) => setFilterType(ev.target.value)
                        },
                            e('option', { value: 'all' }, 'Todos los tipos'),
                            e('option', { value: 'Entrada' }, 'Entradas'),
                            e('option', { value: 'Salida' }, 'Salidas'),
                            e('option', { value: 'Devolucion' }, 'Devoluciones')
                        ),
                        e('input', {
                            type: 'date',
                            className: 'filter-select',
                            value: filterDateFrom,
                            onChange: (ev) => setFilterDateFrom(ev.target.value),
                            placeholder: 'Desde'
                        }),
                        e('input', {
                            type: 'date',
                            className: 'filter-select',
                            value: filterDateTo,
                            onChange: (ev) => setFilterDateTo(ev.target.value),
                            placeholder: 'Hasta'
                        })
                    ),
                    e('div', { className: 'toolbar-right' },
                        e('button', {
                            className: 'button button-secondary',
                            onClick: () => {
                                setSearch('');
                                setFilterType('all');
                                setFilterDateFrom('');
                                setFilterDateTo('');
                            }
                        }, 'ðŸ”„ Limpiar'),
                        e('button', {
                            className: 'button button-success',
                            onClick: () => exportToCSV(filtered, 'historial')
                        }, 'ðŸ“¥ Exportar')
                    )
                ),
                
                filtered.length > 0 ?
                    e('table', { className: 'history-table' },
                        e('thead', null,
                            e('tr', null,
                                e('th', { style: { width: '140px' } }, 'Fecha'),
                                e('th', { style: { width: '100px' } }, 'Tipo'),
                                e('th', null, 'Producto'),
                                e('th', { style: { width: '80px' } }, 'Cant.'),
                                e('th', { style: { width: '120px' } }, 'Ticket'),
                                e('th', null, 'Usuario'),
                                e('th', null, 'TÃ©cnico'),
                                e('th', { style: { width: '80px' } }, 'Firma'),
                                e('th', { style: { width: '60px' } }, 'AcciÃ³n')
                            )
                        ),
                        e('tbody', null,
                            filtered.map(entry =>
                                e('tr', { key: entry.id },
                                    e('td', { style: { fontFamily: 'IBM Plex Mono, monospace', fontSize: '12px' } },
                                        new Date(entry.fecha).toLocaleString('es-ES')
                                    ),
                                    e('td', null,
                                        e('span', { className: `movement-badge ${entry.tipo}` }, entry.tipo)
                                    ),
                                    e('td', { style: { fontWeight: '500' } }, entry.producto),
                                    e('td', { style: { fontFamily: 'IBM Plex Mono, monospace' } }, entry.cantidad),
                                    e('td', { style: { color: 'var(--accent-blue)', fontSize: '12px' } }, entry.ticket || '-'),
                                    e('td', { style: { fontSize: '13px' } }, entry.usuario),
                                    e('td', { style: { color: 'var(--accent-green)', fontSize: '12px' } }, entry.tecnico),
                                    e('td', null,
                                        entry.firma ?
                                            e('img', {
                                                src: entry.firma,
                                                alt: 'Firma',
                                                className: 'signature-preview',
                                                title: 'Haz clic para ampliar'
                                            }) :
                                            e('span', { style: { color: 'var(--text-secondary)', fontSize: '12px' } }, '-')
                                    ),
                                    e('td', null,
                                        e('div', {
                                            className: 'action-icon danger',
                                            onClick: () => onOpenModal('eliminar-historial', entry),
                                            title: 'Eliminar registro'
                                        }, 'ðŸ—‘ï¸')
                                    )
                                )
                            )
                        )
                    ) :
                    e('div', { className: 'empty-state' },
                        e('div', { className: 'empty-state-icon' }, 'ðŸ“‹'),
                        e('div', { className: 'empty-state-title' }, 'No se encontraron movimientos'),
                        e('div', { className: 'empty-state-text' }, 'Intenta ajustar los filtros de bÃºsqueda')
                    )
            );
        }

        function TechniciansView({ state, onRefresh, onOpenModal }) {
            return e('div', null,
                e('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' } },
                    e('h2', { style: { fontSize: '20px', fontWeight: '600' } }, 'ðŸ‘¥ GestiÃ³n de TÃ©cnicos'),
                    e('button', {
                        className: 'button button-success',
                        onClick: () => onOpenModal('tecnico', null)
                    }, 'âž• AÃ±adir TÃ©cnico')
                ),
                
                state.technicians.length > 0 ?
                    e('div', { className: 'inventory-grid' },
                        state.technicians.map(tech =>
                            e('div', { key: tech.id, className: 'inventory-card' },
                                e('div', { className: 'card-header' },
                                    e('div', null,
                                        e('div', { className: 'card-title' }, tech.nombre),
                                        e('div', { className: 'card-category' }, tech.email)
                                    ),
                                    e('div', { className: 'card-barcode' }, tech.codigo)
                                ),
                                
                                e('div', { className: 'card-info' },
                                    e('div', { className: 'info-row' },
                                        e('span', { className: 'info-label' }, 'Estado'),
                                        e('span', { className: `stock-badge ${tech.activo ? 'available' : 'out'}` },
                                            tech.activo ? 'Activo' : 'Inactivo'
                                        )
                                    )
                                ),

                                e('div', { className: 'card-actions' },
                                    e('button', {
                                        className: 'button button-primary',
                                        onClick: () => printTechnicianCard(tech)
                                    }, 'ðŸ–¨ï¸ Imprimir'),
                                    e('button', {
                                        className: `button ${tech.activo ? 'button-warning' : 'button-success'}`,
                                        onClick: () => onOpenModal('toggle-tecnico', tech)
                                    }, tech.activo ? 'â¸ï¸ Desactivar' : 'â–¶ï¸ Activar')
                                )
                            )
                        )
                    ) :
                    e('div', { className: 'empty-state' },
                        e('div', { className: 'empty-state-icon' }, 'ðŸ‘¥'),
                        e('div', { className: 'empty-state-title' }, 'No hay tÃ©cnicos registrados'),
                        e('div', { className: 'empty-state-text' }, 'AÃ±ade tÃ©cnicos para comenzar a usar el sistema')
                    )
            );
        }

        function AssignmentsView({ state, onRefresh, onOpenModal }) {
            const [search, setSearch] = useState('');
            const [filterDepartamento, setFilterDepartamento] = useState('all');
            const [filterEstado, setFilterEstado] = useState('all');

            const filtered = (state.assignments || []).filter(assignment => {
                const matchesSearch = assignment.nombreEmpleado.toLowerCase().includes(search.toLowerCase()) ||
                                    assignment.emailEmpleado.toLowerCase().includes(search.toLowerCase()) ||
                                    assignment.puesto.toLowerCase().includes(search.toLowerCase());
                const matchesDept = filterDepartamento === 'all' || assignment.departamento === filterDepartamento;
                const matchesEstado = filterEstado === 'all' || assignment.estado === filterEstado;
                return matchesSearch && matchesDept && matchesEstado;
            });

            const departamentos = [...new Set((state.assignments || []).map(a => a.departamento))].filter(Boolean);

            return e('div', null,
                e('div', { className: 'toolbar' },
                    e('div', { className: 'toolbar-left' },
                        e('input', {
                            type: 'text',
                            className: 'search-bar',
                            placeholder: 'ðŸ” Buscar asignaciones...',
                            value: search,
                            onChange: (ev) => setSearch(ev.target.value)
                        }),
                        e('select', {
                            className: 'filter-select',
                            value: filterDepartamento,
                            onChange: (ev) => setFilterDepartamento(ev.target.value)
                        },
                            e('option', { value: 'all' }, 'Todos los departamentos'),
                            departamentos.map(dept =>
                                e('option', { key: dept, value: dept }, dept)
                            )
                        ),
                        e('select', {
                            className: 'filter-select',
                            value: filterEstado,
                            onChange: (ev) => setFilterEstado(ev.target.value)
                        },
                            e('option', { value: 'all' }, 'Todos los estados'),
                            e('option', { value: 'Activo' }, 'Activo'),
                            e('option', { value: 'Devuelto' }, 'Devuelto'),
                            e('option', { value: 'Parcial' }, 'Parcial')
                        )
                    ),
                    e('div', { className: 'toolbar-right' },
                        e('button', {
                            className: 'button button-success',
                            onClick: () => onOpenModal('nueva-asignacion', null)
                        }, 'âž• Nueva AsignaciÃ³n'),
                        e('button', {
                            className: 'button button-secondary',
                            onClick: () => exportToCSV(filtered, 'asignaciones')
                        }, 'ðŸ“¥ Exportar')
                    )
                ),
                
                filtered.length > 0 ?
                    e('table', { className: 'history-table' },
                        e('thead', null,
                            e('tr', null,
                                e('th', { style: { width: '140px' } }, 'Fecha'),
                                e('th', null, 'Empleado'),
                                e('th', null, 'Departamento'),
                                e('th', null, 'Puesto'),
                                e('th', { style: { width: '100px' } }, 'Productos'),
                                e('th', { style: { width: '100px' } }, 'Estado'),
                                e('th', { style: { width: '120px' } }, 'Acciones')
                            )
                        ),
                        e('tbody', null,
                            filtered.map(assignment =>
                                e('tr', { key: assignment.id },
                                    e('td', { style: { fontFamily: 'IBM Plex Mono, monospace', fontSize: '12px' } },
                                        new Date(assignment.fechaAsignacion).toLocaleDateString('es-ES')
                                    ),
                                    e('td', null,
                                        e('div', { style: { fontWeight: '600' } }, assignment.nombreEmpleado),
                                        e('div', { style: { fontSize: '12px', color: 'var(--text-secondary)' } }, assignment.emailEmpleado)
                                    ),
                                    e('td', null, assignment.departamento),
                                    e('td', null, assignment.puesto),
                                    e('td', { style: { textAlign: 'center', fontFamily: 'IBM Plex Mono, monospace', fontWeight: '700' } },
                                        assignment.cantidadProductos
                                    ),
                                    e('td', null,
                                        e('span', {
                                            className: `movement-badge ${assignment.estado === 'Activo' ? 'Entrada' : assignment.estado === 'Devuelto' ? 'Devolucion' : 'Salida'}`
                                        }, assignment.estado)
                                    ),
                                    e('td', null,
                                        e('div', { style: { display: 'flex', gap: '8px', justifyContent: 'center' } },
                                            e('div', {
                                                className: 'action-icon',
                                                onClick: () => onOpenModal('ver-asignacion', assignment),
                                                title: 'Ver documento'
                                            }, 'ðŸ“„'),
                                            assignment.estado === 'Activo' && e('div', {
                                                className: 'action-icon',
                                                onClick: () => onOpenModal('devolver-material', assignment),
                                                title: 'Devolver material'
                                            }, 'â†©ï¸')
                                        )
                                    )
                                )
                            )
                        )
                    ) :
                    e('div', { className: 'empty-state' },
                        e('div', { className: 'empty-state-icon' }, 'ðŸ“„'),
                        e('div', { className: 'empty-state-title' }, 'No hay asignaciones'),
                        e('div', { className: 'empty-state-text' }, 'Crea la primera asignaciÃ³n de material')
                    )
            );
        }

        function FormModal({ state, modalType, selectedItem, onClose, onSubmit, onRefresh }) {
            const [formData, setFormData] = useState({
                nombre: selectedItem?.nombre || '',
                categoria: selectedItem?.categoria || '',
                barcode: selectedItem?.barcode || '',
                stock: selectedItem?.stock || '',
                stockMinimo: selectedItem?.stockMinimo || '',
                ubicacion: selectedItem?.ubicacion || '',
                cantidad: '',
                ticket: '',
                usuario: '',
                nombreTecnico: '',
                emailTecnico: '',
                codigoTecnico: '',
                nombreEmpleado: '',
                emailEmpleado: '',
                departamento: '',
                puesto: '',
                fechaIncorporacion: '',
                observaciones: ''
            });
            const [signature, setSignature] = useState(null);
            const [selectedProducts, setSelectedProducts] = useState([]);
            const [isDrawing, setIsDrawing] = useState(false);
            const [loading, setLoading] = useState(false);
            const canvasRef = useRef(null);

            useEffect(() => {
                if (canvasRef.current && (modalType === 'salida' || modalType === 'nueva-asignacion')) {
                    const canvas = canvasRef.current;
                    canvas.width = canvas.offsetWidth;
                    canvas.height = canvas.offsetHeight;
                }
            }, [modalType]);

            const startDrawing = (ev) => {
                setIsDrawing(true);
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                const rect = canvas.getBoundingClientRect();
                const x = (ev.touches ? ev.touches[0].clientX : ev.clientX) - rect.left;
                const y = (ev.touches ? ev.touches[0].clientY : ev.clientY) - rect.top;
                ctx.beginPath();
                ctx.moveTo(x, y);
            };

            const draw = (ev) => {
                if (!isDrawing) return;
                ev.preventDefault();
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                const rect = canvas.getBoundingClientRect();
                const x = (ev.touches ? ev.touches[0].clientX : ev.clientX) - rect.left;
                const y = (ev.touches ? ev.touches[0].clientY : ev.clientY) - rect.top;
                ctx.strokeStyle = '#e6edf3';
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.lineTo(x, y);
                ctx.stroke();
            };

            const stopDrawing = () => {
                if (isDrawing) {
                    setIsDrawing(false);
                    const canvas = canvasRef.current;
                    setSignature(canvas.toDataURL());
                }
            };

            const clearSignature = () => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                setSignature(null);
            };

            const handleSubmit = async (ev) => {
                ev.preventDefault();
                
                if (modalType === 'salida' && !signature) {
                    showToast('La firma es obligatoria', 'error');
                    return;
                }

                setLoading(true);
                try {
                    if (modalType === 'entrada') {
                        if (selectedItem) {
                            // AÃ±adir stock
                            const nuevoStock = selectedItem.stock + parseInt(formData.cantidad);
                            await dataManager.updateInventoryItem(selectedItem.id, {
                                Stock: nuevoStock
                            });
                            await dataManager.addToHistory({
                                tipo: 'Entrada',
                                producto: selectedItem.nombre,
                                cantidad: parseInt(formData.cantidad),
                                tecnico: state.user.name
                            });
                            showToast(`${formData.cantidad} unidades aÃ±adidas`, 'success');
                        } else {
                            // Crear producto nuevo
                            await dataManager.createInventoryItem({
                                nombre: formData.nombre,
                                categoria: formData.categoria,
                                barcode: formData.barcode,
                                stock: parseInt(formData.stock),
                                stockMinimo: parseInt(formData.stockMinimo),
                                ubicacion: formData.ubicacion
                            });
                            await dataManager.addToHistory({
                                tipo: 'Entrada',
                                producto: formData.nombre,
                                cantidad: parseInt(formData.stock),
                                tecnico: state.user.name
                            });
                            showToast(`Producto "${formData.nombre}" aÃ±adido`, 'success');
                        }
                    } else if (modalType === 'salida') {
                        const nuevoStock = Math.max(0, selectedItem.stock - parseInt(formData.cantidad));
                        await dataManager.updateInventoryItem(selectedItem.id, {
                            Stock: nuevoStock
                        });
                        await dataManager.addToHistory({
                            tipo: 'Salida',
                            producto: selectedItem.nombre,
                            cantidad: parseInt(formData.cantidad),
                            ticket: formData.ticket,
                            usuario: formData.usuario,
                            tecnico: state.user.name,
                            firma: signature
                        });
                        showToast('Salida registrada correctamente', 'success');
                    } else if (modalType === 'editar') {
                        await dataManager.updateInventoryItem(selectedItem.id, {
                            Nombre: formData.nombre,
                            Categoria: formData.categoria,
                            Stock: parseInt(formData.stock),
                            StockMinimo: parseInt(formData.stockMinimo),
                            Ubicacion: formData.ubicacion
                        });
                        showToast('Producto actualizado correctamente', 'success');
                    } else if (modalType === 'tecnico') {
                        await dataManager.createTechnician({
                            nombre: formData.nombreTecnico,
                            codigo: formData.codigoTecnico,
                            email: formData.emailTecnico
                        });
                        showToast('TÃ©cnico aÃ±adido correctamente', 'success');
                    } else if (modalType === 'nueva-asignacion') {
                        if (!signature) {
                            showToast('La firma del empleado es obligatoria', 'error');
                            return;
                        }
                        if (selectedProducts.length === 0) {
                            showToast('Debes seleccionar al menos un producto', 'error');
                            return;
                        }

                        // Actualizar stock de cada producto
                        for (const prod of selectedProducts) {
                            const producto = state.inventory.find(p => p.id === prod.id);
                            if (producto) {
                                const nuevoStock = Math.max(0, producto.stock - 1);
                                await dataManager.updateInventoryItem(producto.id, {
                                    Stock: nuevoStock
                                });
                                
                                // Registrar en historial
                                await dataManager.addToHistory({
                                    tipo: 'Asignacion',
                                    producto: producto.nombre,
                                    cantidad: 1,
                                    usuario: formData.nombreEmpleado,
                                    tecnico: state.user.name,
                                    firma: signature
                                });
                            }
                        }

                        // Crear asignaciÃ³n
                        await dataManager.createAssignment({
                            nombreEmpleado: formData.nombreEmpleado,
                            emailEmpleado: formData.emailEmpleado,
                            departamento: formData.departamento,
                            puesto: formData.puesto,
                            fechaIncorporacion: formData.fechaIncorporacion,
                            productosAsignados: selectedProducts,
                            firmaEmpleado: signature,
                            tecnicoResponsable: state.user.name,
                            observaciones: formData.observaciones
                        });

                        showToast(`AsignaciÃ³n creada para ${formData.nombreEmpleado}`, 'success');
                    }

                    await onRefresh();
                    onClose();
                } catch (error) {
                    console.error('Error:', error);
                    showToast('Error al guardar. Intenta de nuevo.', 'error');
                } finally {
                    setLoading(false);
                }
            };

            const getModalTitle = () => {
                if (modalType === 'entrada') return selectedItem ? 'AÃ±adir Stock' : 'Nuevo Producto';
                if (modalType === 'salida') return 'Registrar Salida';
                if (modalType === 'devolucion') return 'Registrar DevoluciÃ³n';
                if (modalType === 'editar') return 'Editar Producto';
                if (modalType === 'tecnico') return 'Nuevo TÃ©cnico';
                if (modalType === 'nueva-asignacion') return 'ðŸ“„ Nueva AsignaciÃ³n de Material';
                if (modalType === 'ver-asignacion') return 'ðŸ“„ Documento de AsignaciÃ³n';
                if (modalType === 'devolver-material') return 'â†©ï¸ DevoluciÃ³n de Material';
                return 'Formulario';
            };

            return e('div', { className: 'modal-overlay', onClick: onClose },
                e('div', { className: 'modal', onClick: (ev) => ev.stopPropagation() },
                    e('div', { className: 'modal-header' },
                        e('h2', { className: 'modal-title' }, getModalTitle()),
                        e('button', { className: 'modal-close', onClick: onClose }, 'Ã—')
                    ),
                    
                    e('form', { onSubmit: handleSubmit },
                        e('div', { className: 'modal-body' },
                            modalType === 'tecnico' && [
                                e('div', { key: 'nombre', className: 'form-group' },
                                    e('label', { className: 'form-label' }, 'Nombre Completo *'),
                                    e('input', {
                                        type: 'text',
                                        className: 'form-input',
                                        value: formData.nombreTecnico,
                                        onChange: (ev) => setFormData({...formData, nombreTecnico: ev.target.value}),
                                        required: true
                                    })
                                ),
                                e('div', { key: 'email', className: 'form-group' },
                                    e('label', { className: 'form-label' }, 'Email *'),
                                    e('input', {
                                        type: 'email',
                                        className: 'form-input',
                                        value: formData.emailTecnico,
                                        onChange: (ev) => setFormData({...formData, emailTecnico: ev.target.value}),
                                        required: true
                                    })
                                ),
                                e('div', { key: 'codigo', className: 'form-group' },
                                    e('label', { className: 'form-label' }, 'CÃ³digo de TÃ©cnico *'),
                                    e('input', {
                                        type: 'text',
                                        className: 'form-input',
                                        placeholder: 'TEC-XXX',
                                        value: formData.codigoTecnico,
                                        onChange: (ev) => setFormData({...formData, codigoTecnico: ev.target.value}),
                                        required: true
                                    })
                                )
                            ],

                            (modalType === 'entrada' || modalType === 'editar') && !selectedItem && [
                                e('div', { key: 'row1', className: 'form-row' },
                                    e('div', { className: 'form-group' },
                                        e('label', { className: 'form-label' }, 'Nombre del Producto *'),
                                        e('input', {
                                            type: 'text',
                                            className: 'form-input',
                                            value: formData.nombre,
                                            onChange: (ev) => setFormData({...formData, nombre: ev.target.value}),
                                            required: true
                                        })
                                    ),
                                    e('div', { className: 'form-group' },
                                        e('label', { className: 'form-label' }, 'CategorÃ­a *'),
                                        e('select', {
                                            className: 'form-select',
                                            value: formData.categoria,
                                            onChange: (ev) => setFormData({...formData, categoria: ev.target.value}),
                                            required: true
                                        },
                                            e('option', { value: '' }, 'Seleccionar...'),
                                            ['PortÃ¡tiles', 'Smartphones', 'Tablets', 'PerifÃ©ricos', 'Audio', 'Cables', 'Accesorios'].map(cat =>
                                                e('option', { key: cat, value: cat }, cat)
                                            )
                                        )
                                    )
                                ),
                                e('div', { key: 'row2', className: 'form-row' },
                                    modalType !== 'editar' && e('div', { className: 'form-group' },
                                        e('label', { className: 'form-label' }, 'CÃ³digo de Barras *'),
                                        e('div', { style: { display: 'flex', gap: '8px' } },
                                            e('input', {
                                                type: 'text',
                                                className: 'form-input',
                                                value: formData.barcode,
                                                onChange: (ev) => setFormData({...formData, barcode: ev.target.value}),
                                                required: true,
                                                style: { flex: 1 }
                                            }),
                                            e('button', {
                                                type: 'button',
                                                className: 'button button-primary',
                                                onClick: () => {
                                                    startBarcodeScanner((code) => {
                                                        setFormData({...formData, barcode: code});
                                                        showToast('CÃ³digo escaneado: ' + code, 'success');
                                                    });
                                                },
                                                style: { padding: '12px 16px', minWidth: 'auto' }
                                            }, 'ðŸ“·')
                                        )
                                    ),
                                    e('div', { className: 'form-group' },
                                        e('label', { className: 'form-label' }, 'UbicaciÃ³n'),
                                        e('input', {
                                            type: 'text',
                                            className: 'form-input',
                                            placeholder: 'Ej: A1, B2...',
                                            value: formData.ubicacion,
                                            onChange: (ev) => setFormData({...formData, ubicacion: ev.target.value})
                                        })
                                    )
                                ),
                                e('div', { key: 'row3', className: 'form-row' },
                                    e('div', { className: 'form-group' },
                                        e('label', { className: 'form-label' }, modalType === 'editar' ? 'Stock Actual *' : 'Stock Inicial *'),
                                        e('input', {
                                            type: 'number',
                                            className: 'form-input',
                                            min: '0',
                                            value: formData.stock,
                                            onChange: (ev) => setFormData({...formData, stock: ev.target.value}),
                                            required: true
                                        })
                                    ),
                                    e('div', { className: 'form-group' },
                                        e('label', { className: 'form-label' }, 'Stock MÃ­nimo *'),
                                        e('input', {
                                            type: 'number',
                                            className: 'form-input',
                                            min: '0',
                                            value: formData.stockMinimo,
                                            onChange: (ev) => setFormData({...formData, stockMinimo: ev.target.value}),
                                            required: true
                                        })
                                    )
                                )
                            ],

                            modalType === 'editar' && selectedItem && [
                                e('div', { key: 'row1', className: 'form-row' },
                                    e('div', { className: 'form-group' },
                                        e('label', { className: 'form-label' }, 'Nombre del Producto *'),
                                        e('input', {
                                            type: 'text',
                                            className: 'form-input',
                                            value: formData.nombre,
                                            onChange: (ev) => setFormData({...formData, nombre: ev.target.value}),
                                            required: true
                                        })
                                    ),
                                    e('div', { className: 'form-group' },
                                        e('label', { className: 'form-label' }, 'CategorÃ­a *'),
                                        e('select', {
                                            className: 'form-select',
                                            value: formData.categoria,
                                            onChange: (ev) => setFormData({...formData, categoria: ev.target.value}),
                                            required: true
                                        },
                                            e('option', { value: '' }, 'Seleccionar...'),
                                            ['PortÃ¡tiles', 'Smartphones', 'Tablets', 'PerifÃ©ricos', 'Audio', 'Cables', 'Accesorios'].map(cat =>
                                                e('option', { key: cat, value: cat }, cat)
                                            )
                                        )
                                    )
                                ),
                                e('div', { key: 'row2', className: 'form-row' },
                                    e('div', { className: 'form-group' },
                                        e('label', { className: 'form-label' }, 'Stock Actual *'),
                                        e('input', {
                                            type: 'number',
                                            className: 'form-input',
                                            min: '0',
                                            value: formData.stock,
                                            onChange: (ev) => setFormData({...formData, stock: ev.target.value}),
                                            required: true
                                        })
                                    ),
                                    e('div', { className: 'form-group' },
                                        e('label', { className: 'form-label' }, 'Stock MÃ­nimo *'),
                                        e('input', {
                                            type: 'number',
                                            className: 'form-input',
                                            min: '0',
                                            value: formData.stockMinimo,
                                            onChange: (ev) => setFormData({...formData, stockMinimo: ev.target.value}),
                                            required: true
                                        })
                                    )
                                ),
                                e('div', { key: 'ubicacion', className: 'form-group' },
                                    e('label', { className: 'form-label' }, 'UbicaciÃ³n'),
                                    e('input', {
                                        type: 'text',
                                        className: 'form-input',
                                        placeholder: 'Ej: A1, B2...',
                                        value: formData.ubicacion,
                                        onChange: (ev) => setFormData({...formData, ubicacion: ev.target.value})
                                    })
                                ),
                                e('div', { key: 'warning', style: { background: 'rgba(249, 115, 22, 0.1)', padding: '12px', borderRadius: '8px', fontSize: '13px', color: 'var(--accent-orange)', marginTop: '16px' } },
                                    'âš ï¸ ', e('strong', null, 'Admin:'), ' EstÃ¡s editando el stock directamente. Esta acciÃ³n quedarÃ¡ registrada.'
                                )
                            ],

                            modalType === 'entrada' && selectedItem &&
                                e('div', { className: 'form-group' },
                                    e('label', { className: 'form-label' }, 'Cantidad a AÃ±adir *'),
                                    e('input', {
                                        type: 'number',
                                        className: 'form-input',
                                        min: '1',
                                        value: formData.cantidad,
                                        onChange: (ev) => setFormData({...formData, cantidad: ev.target.value}),
                                        required: true
                                    })
                                ),

                            modalType === 'salida' && [
                                e('div', { key: 'cantidad', className: 'form-group' },
                                    e('label', { className: 'form-label' }, 'Cantidad *'),
                                    e('input', {
                                        type: 'number',
                                        className: 'form-input',
                                        min: '1',
                                        max: selectedItem?.stock,
                                        value: formData.cantidad,
                                        onChange: (ev) => setFormData({...formData, cantidad: ev.target.value}),
                                        required: true
                                    }),
                                    selectedItem && e('p', { style: { fontSize: '12px', color: 'var(--text-secondary)', marginTop: '4px' } },
                                        `Stock disponible: ${selectedItem.stock} unidades`
                                    )
                                ),
                                e('div', { key: 'ticket', className: 'form-group' },
                                    e('label', { className: 'form-label' }, 'NÂº Ticket'),
                                    e('input', {
                                        type: 'text',
                                        className: 'form-input',
                                        placeholder: 'TKT-2024-XXX',
                                        value: formData.ticket,
                                        onChange: (ev) => setFormData({...formData, ticket: ev.target.value})
                                    })
                                ),
                                e('div', { key: 'usuario', className: 'form-group' },
                                    e('label', { className: 'form-label' }, `Usuario ${!formData.ticket ? '*' : ''}`),
                                    e('input', {
                                        type: 'text',
                                        className: 'form-input',
                                        placeholder: 'Nombre del usuario',
                                        value: formData.usuario,
                                        onChange: (ev) => setFormData({...formData, usuario: ev.target.value}),
                                        required: !formData.ticket
                                    })
                                ),
                                e('div', { key: 'firma', className: 'signature-container' },
                                    e('div', { className: 'signature-label' },
                                        'âœï¸ Firma del Empleado ', e('span', { className: 'required-asterisk' }, '*')
                                    ),
                                    e('canvas', {
                                        ref: canvasRef,
                                        className: 'signature-canvas',
                                        onMouseDown: startDrawing,
                                        onMouseMove: draw,
                                        onMouseUp: stopDrawing,
                                        onMouseLeave: stopDrawing,
                                        onTouchStart: startDrawing,
                                        onTouchMove: draw,
                                        onTouchEnd: stopDrawing
                                    }),
                                    e('div', { className: 'signature-actions' },
                                        e('button', {
                                            type: 'button',
                                            className: 'button button-secondary',
                                            onClick: clearSignature
                                        }, 'ðŸ—‘ï¸ Limpiar Firma')
                                    ),
                                    e('p', { style: { fontSize: '12px', color: 'var(--text-secondary)', marginTop: '8px' } },
                                        'ðŸ’¡ El empleado debe firmar con el dedo o Apple Pencil'
                                    )
                                )
                            ],

                            modalType === 'nueva-asignacion' && [
                                e('h3', { key: 'header-empleado', style: { fontSize: '16px', fontWeight: '600', marginBottom: '16px', color: 'var(--accent-blue)' } }, 
                                    'ðŸ‘¤ Datos del Empleado'
                                ),
                                e('div', { key: 'row-empleado1', className: 'form-row' },
                                    e('div', { className: 'form-group' },
                                        e('label', { className: 'form-label' }, 'Nombre Completo *'),
                                        e('input', {
                                            type: 'text',
                                            className: 'form-input',
                                            value: formData.nombreEmpleado,
                                            onChange: (ev) => setFormData({...formData, nombreEmpleado: ev.target.value}),
                                            required: true
                                        })
                                    ),
                                    e('div', { className: 'form-group' },
                                        e('label', { className: 'form-label' }, 'Email Corporativo *'),
                                        e('input', {
                                            type: 'email',
                                            className: 'form-input',
                                            value: formData.emailEmpleado,
                                            onChange: (ev) => setFormData({...formData, emailEmpleado: ev.target.value}),
                                            required: true
                                        })
                                    )
                                ),
                                e('div', { key: 'row-empleado2', className: 'form-row' },
                                    e('div', { className: 'form-group' },
                                        e('label', { className: 'form-label' }, 'Departamento *'),
                                        e('select', {
                                            className: 'form-select',
                                            value: formData.departamento,
                                            onChange: (ev) => setFormData({...formData, departamento: ev.target.value}),
                                            required: true
                                        },
                                            e('option', { value: '' }, 'Seleccionar...'),
                                            ['IT', 'RRHH', 'Ventas', 'Marketing', 'Finanzas', 'Operaciones', 'LogÃ­stica'].map(dept =>
                                                e('option', { key: dept, value: dept }, dept)
                                            )
                                        )
                                    ),
                                    e('div', { className: 'form-group' },
                                        e('label', { className: 'form-label' }, 'Puesto *'),
                                        e('input', {
                                            type: 'text',
                                            className: 'form-input',
                                            value: formData.puesto,
                                            onChange: (ev) => setFormData({...formData, puesto: ev.target.value}),
                                            required: true
                                        })
                                    )
                                ),
                                e('div', { key: 'fecha-incorporacion', className: 'form-group' },
                                    e('label', { className: 'form-label' }, 'Fecha de IncorporaciÃ³n *'),
                                    e('input', {
                                        type: 'date',
                                        className: 'form-input',
                                        value: formData.fechaIncorporacion,
                                        onChange: (ev) => setFormData({...formData, fechaIncorporacion: ev.target.value}),
                                        required: true
                                    })
                                ),

                                e('h3', { key: 'header-productos', style: { fontSize: '16px', fontWeight: '600', margin: '24px 0 16px 0', color: 'var(--accent-green)' } }, 
                                    'ðŸ“¦ Material Asignado'
                                ),
                                e('div', { key: 'productos-selector', style: { marginBottom: '16px' } },
                                    e('button', {
                                        type: 'button',
                                        className: 'button button-primary',
                                        onClick: () => {
                                            startBarcodeScanner((code) => {
                                                const producto = state.inventory.find(p => p.barcode === code);
                                                if (producto && producto.stock > 0) {
                                                    if (!selectedProducts.find(p => p.id === producto.id)) {
                                                        setSelectedProducts([...selectedProducts, producto]);
                                                        showToast(`${producto.nombre} aÃ±adido`, 'success');
                                                    } else {
                                                        showToast('Producto ya aÃ±adido', 'warning');
                                                    }
                                                } else {
                                                    showToast('Producto no encontrado o sin stock', 'error');
                                                }
                                            });
                                        }
                                    }, 'ðŸ“· Escanear Producto')
                                ),
                                e('div', { key: 'productos-list', style: { 
                                    background: 'var(--bg-primary)', 
                                    border: '2px solid var(--border)', 
                                    borderRadius: '8px', 
                                    padding: '16px',
                                    maxHeight: '200px',
                                    overflowY: 'auto'
                                } },
                                    selectedProducts.length > 0 ?
                                        selectedProducts.map((prod, idx) =>
                                            e('div', {
                                                key: idx,
                                                style: {
                                                    display: 'flex',
                                                    justifyContent: 'space-between',
                                                    alignItems: 'center',
                                                    padding: '8px 12px',
                                                    background: 'var(--bg-secondary)',
                                                    borderRadius: '6px',
                                                    marginBottom: idx < selectedProducts.length - 1 ? '8px' : '0'
                                                }
                                            },
                                                e('div', null,
                                                    e('div', { style: { fontWeight: '600', fontSize: '14px' } }, prod.nombre),
                                                    e('div', { style: { fontSize: '12px', color: 'var(--text-secondary)' } }, prod.categoria)
                                                ),
                                                e('button', {
                                                    type: 'button',
                                                    onClick: () => setSelectedProducts(selectedProducts.filter((_, i) => i !== idx)),
                                                    style: {
                                                        background: 'none',
                                                        border: 'none',
                                                        color: 'var(--accent-red)',
                                                        cursor: 'pointer',
                                                        fontSize: '18px',
                                                        padding: '4px 8px'
                                                    }
                                                }, 'Ã—')
                                            )
                                        ) :
                                        e('div', { style: { textAlign: 'center', color: 'var(--text-secondary)', padding: '20px' } },
                                            'ðŸ“¦ Escanea productos para aÃ±adir'
                                        )
                                ),

                                e('div', { key: 'observaciones', className: 'form-group', style: { marginTop: '16px' } },
                                    e('label', { className: 'form-label' }, 'Observaciones'),
                                    e('textarea', {
                                        className: 'form-textarea',
                                        value: formData.observaciones,
                                        onChange: (ev) => setFormData({...formData, observaciones: ev.target.value}),
                                        placeholder: 'Notas adicionales...'
                                    })
                                ),

                                e('div', { key: 'firma-asignacion', className: 'signature-container', style: { marginTop: '24px' } },
                                    e('div', { className: 'signature-label' },
                                        'âœï¸ Firma del Empleado ', e('span', { className: 'required-asterisk' }, '*')
                                    ),
                                    e('canvas', {
                                        ref: canvasRef,
                                        className: 'signature-canvas',
                                        style: { height: '250px' },
                                        onMouseDown: startDrawing,
                                        onMouseMove: draw,
                                        onMouseUp: stopDrawing,
                                        onMouseLeave: stopDrawing,
                                        onTouchStart: startDrawing,
                                        onTouchMove: draw,
                                        onTouchEnd: stopDrawing
                                    }),
                                    e('div', { className: 'signature-actions' },
                                        e('button', {
                                            type: 'button',
                                            className: 'button button-secondary',
                                            onClick: clearSignature
                                        }, 'ðŸ—‘ï¸ Limpiar Firma')
                                    ),
                                    e('p', { style: { fontSize: '12px', color: 'var(--text-secondary)', marginTop: '8px' } },
                                        'ðŸ’¡ El empleado debe firmar con el dedo o Apple Pencil para confirmar la recepciÃ³n del material'
                                    )
                                )
                            ]
                        ),

                        e('div', { className: 'modal-footer' },
                            e('button', { type: 'button', className: 'button button-secondary', onClick: onClose }, 'Cancelar'),
                            e('button', {
                                type: 'submit',
                                className: `button ${
                                    modalType === 'entrada' ? 'button-success' : 
                                    modalType === 'salida' ? 'button-primary' : 
                                    modalType === 'devolucion' ? 'button-warning' :
                                    modalType === 'editar' ? 'button-purple' :
                                    modalType === 'nueva-asignacion' ? 'button-success' :
                                    'button-success'
                                }`,
                                disabled: loading
                            },
                                loading ? e('span', { className: 'loading-spinner' }) : null,
                                loading ? ' Guardando...' :
                                modalType === 'entrada' ? 'AÃ±adir' : 
                                modalType === 'salida' ? 'Registrar Salida' : 
                                modalType === 'devolucion' ? 'Registrar DevoluciÃ³n' :
                                modalType === 'editar' ? 'Guardar Cambios' :
                                modalType === 'nueva-asignacion' ? 'ðŸ“„ Crear AsignaciÃ³n' :
                                'Crear TÃ©cnico'
                            )
                        )
                    )
                )
            );
        }

        function AssignmentDocumentModal({ assignment, onClose }) {
            if (!assignment) return null;

            return e('div', { className: 'modal-overlay', onClick: onClose },
                e('div', { className: 'modal', style: { maxWidth: '800px' }, onClick: (ev) => ev.stopPropagation() },
                    e('div', { className: 'modal-header' },
                        e('h2', { className: 'modal-title' }, 'ðŸ“„ Documento de AsignaciÃ³n'),
                        e('button', { className: 'modal-close', onClick: onClose }, 'Ã—')
                    ),
                    
                    e('div', { className: 'modal-body', style: { fontSize: '14px', lineHeight: '1.8' } },
                        e('div', { style: { textAlign: 'center', marginBottom: '32px', paddingBottom: '24px', borderBottom: '2px solid var(--border)' } },
                            e('h1', { style: { fontSize: '24px', marginBottom: '8px' } }, 'ðŸ¢ SANLUCAR FRUIT'),
                            e('h2', { style: { fontSize: '16px', color: 'var(--accent-purple)', fontWeight: '600' } }, 'ACTA DE ASIGNACIÃ“N DE MATERIAL IT')
                        ),

                        e('div', { style: { marginBottom: '24px' } },
                            e('h3', { style: { fontSize: '16px', fontWeight: '700', color: 'var(--accent-blue)', marginBottom: '12px', borderBottom: '1px solid var(--border)', paddingBottom: '8px' } }, 'DATOS DEL EMPLEADO'),
                            e('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', padding: '12px', background: 'var(--bg-tertiary)', borderRadius: '8px' } },
                                e('div', null, e('strong', null, 'Nombre: '), assignment.nombreEmpleado),
                                e('div', null, e('strong', null, 'Email: '), assignment.emailEmpleado),
                                e('div', null, e('strong', null, 'Departamento: '), assignment.departamento),
                                e('div', null, e('strong', null, 'Puesto: '), assignment.puesto),
                                e('div', null, e('strong', null, 'Fecha Alta: '), new Date(assignment.fechaIncorporacion).toLocaleDateString('es-ES'))
                            )
                        ),

                        e('div', { style: { marginBottom: '24px' } },
                            e('h3', { style: { fontSize: '16px', fontWeight: '700', color: 'var(--accent-green)', marginBottom: '12px', borderBottom: '1px solid var(--border)', paddingBottom: '8px' } }, 'MATERIAL ASIGNADO'),
                            e('div', { style: { padding: '12px', background: 'var(--bg-tertiary)', borderRadius: '8px' } },
                                assignment.productosAsignados.map((prod, idx) =>
                                    e('div', {
                                        key: idx,
                                        style: {
                                            padding: '12px',
                                            background: 'var(--bg-primary)',
                                            borderRadius: '6px',
                                            marginBottom: idx < assignment.productosAsignados.length - 1 ? '8px' : '0'
                                        }
                                    },
                                        e('div', { style: { fontWeight: '600' } }, `${idx + 1}. ${prod.nombre}`),
                                        e('div', { style: { fontSize: '12px', color: 'var(--text-secondary)' } }, `CÃ³digo: ${prod.barcode} | CategorÃ­a: ${prod.categoria}`)
                                    )
                                )
                            )
                        ),

                        e('div', { style: { marginBottom: '24px', padding: '16px', background: 'rgba(249, 115, 22, 0.1)', border: '1px solid var(--accent-orange)', borderRadius: '8px' } },
                            e('h3', { style: { fontSize: '14px', fontWeight: '700', color: 'var(--accent-orange)', marginBottom: '12px' } }, 'CONDICIONES DE USO'),
                            e('div', { style: { fontSize: '13px', lineHeight: '1.6' } },
                                'El empleado declara haber recibido el material en perfecto estado y se compromete a:',
                                e('ul', { style: { marginTop: '8px', marginLeft: '20px' } },
                                    e('li', null, 'Hacer un uso adecuado del mismo'),
                                    e('li', null, 'Mantenerlo en buen estado de conservaciÃ³n'),
                                    e('li', null, 'Devolverlo cuando finalice su relaciÃ³n laboral'),
                                    e('li', null, 'Notificar cualquier incidencia o daÃ±o'),
                                    e('li', null, 'No ceder el material a terceros')
                                )
                            )
                        ),

                        assignment.observaciones && e('div', { style: { marginBottom: '24px' } },
                            e('h3', { style: { fontSize: '16px', fontWeight: '700', marginBottom: '12px', borderBottom: '1px solid var(--border)', paddingBottom: '8px' } }, 'OBSERVACIONES'),
                            e('div', { style: { padding: '12px', background: 'var(--bg-tertiary)', borderRadius: '8px', fontSize: '13px' } }, assignment.observaciones)
                        ),

                        e('div', { style: { marginTop: '32px', paddingTop: '24px', borderTop: '2px solid var(--border)' } },
                            e('h3', { style: { fontSize: '16px', fontWeight: '700', marginBottom: '16px' } }, 'FIRMAS'),
                            e('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '24px' } },
                                e('div', { style: { textAlign: 'center' } },
                                    e('div', { style: { marginBottom: '12px' } },
                                        assignment.firmaEmpleado && e('img', {
                                            src: assignment.firmaEmpleado,
                                            alt: 'Firma empleado',
                                            style: { maxWidth: '200px', maxHeight: '100px', border: '1px solid var(--border)', borderRadius: '6px', padding: '8px', background: 'white' }
                                        })
                                    ),
                                    e('div', { style: { fontWeight: '600' } }, 'Empleado'),
                                    e('div', { style: { fontSize: '12px', color: 'var(--text-secondary)' } }, assignment.nombreEmpleado)
                                ),
                                e('div', { style: { textAlign: 'center' } },
                                    e('div', { style: { marginBottom: '12px', height: '100px', display: 'flex', alignItems: 'center', justifyContent: 'center' } },
                                        e('div', { style: { fontSize: '14px', fontWeight: '600', color: 'var(--accent-blue)' } }, 'âœ“ Verificado')
                                    ),
                                    e('div', { style: { fontWeight: '600' } }, 'TÃ©cnico IT'),
                                    e('div', { style: { fontSize: '12px', color: 'var(--text-secondary)' } }, assignment.tecnicoResponsable)
                                )
                            ),
                            e('div', { style: { textAlign: 'center', marginTop: '24px', fontSize: '12px', color: 'var(--text-secondary)' } },
                                `Fecha de asignaciÃ³n: ${new Date(assignment.fechaAsignacion).toLocaleString('es-ES')} | Sanlucar Fruit`
                            )
                        )
                    ),

                    e('div', { className: 'modal-footer' },
                        e('button', {
                            type: 'button',
                            className: 'button button-secondary',
                            onClick: onClose
                        }, 'Cerrar'),
                        e('button', {
                            type: 'button',
                            className: 'button button-primary',
                            onClick: () => {
                                window.print();
                            }
                        }, 'ðŸ–¨ï¸ Imprimir / Guardar PDF')
                    )
                )
            );
        }

        function ConfirmModal({ message, onConfirm, onCancel, loading }) {
            return e('div', { className: 'modal-overlay', onClick: onCancel },
                e('div', { className: 'modal', style: { maxWidth: '500px' }, onClick: (ev) => ev.stopPropagation() },
                    e('div', { className: 'modal-header' },
                        e('h2', { className: 'modal-title' }, 'âš ï¸ Confirmar AcciÃ³n'),
                        e('button', { className: 'modal-close', onClick: onCancel }, 'Ã—')
                    ),
                    
                    e('div', { className: 'modal-body' },
                        e('p', { style: { fontSize: '16px', color: 'var(--text-primary)', marginBottom: '24px' } }, message),
                        e('div', { style: { background: 'rgba(239, 68, 68, 0.1)', padding: '12px', borderRadius: '8px', fontSize: '14px', color: 'var(--accent-red)' } },
                            'âš ï¸ Esta acciÃ³n es permanente y no se puede deshacer'
                        )
                    ),

                    e('div', { className: 'modal-footer' },
                        e('button', { type: 'button', className: 'button button-secondary', onClick: onCancel }, 'Cancelar'),
                        e('button', {
                            className: 'button button-danger',
                            onClick: onConfirm,
                            disabled: loading
                        },
                            loading ? e('span', { className: 'loading-spinner' }) : null,
                            loading ? ' Eliminando...' : 'SÃ­, Eliminar'
                        )
                    )
                )
            );
        }

        function App() {
            const [state, setState] = useState({
                user: null,
                isAdmin: false,
                inventory: [],
                technicians: [],
                history: [],
                assignments: [],
                activeTab: 'dashboard',
                loading: true,
                modalType: null,
                selectedItem: null,
                showConfirm: false,
                confirmAction: null
            });

            useEffect(() => {
                initializeApp();
            }, []);

            const initializeApp = async () => {
                try {
                    const msalReady = await initializeMSAL();
                    if (!msalReady) throw new Error('Failed to initialize MSAL');

                    const accounts = msalInstance.getAllAccounts();
                    if (accounts.length === 0) {
                        setState({ ...state, loading: false });
                        return;
                    }

                    const token = await getAccessToken();
                    if (!token) {
                        setState({ ...state, loading: false });
                        return;
                    }

                    graphClient = new GraphAPIClient(token);
                    dataManager = new DataManager(graphClient);
                    
                    const currentUser = await graphClient.getCurrentUser();
                    const data = await dataManager.loadAllData();

                    const isAdmin = data.admins.some(a => 
                        a.Email && a.Email.toLowerCase() === currentUser.mail.toLowerCase() && 
                        (a.Activo === true || a.Activo === 'Yes')
                    );

                    setState({
                        ...state,
                        user: { name: currentUser.displayName, email: currentUser.mail },
                        isAdmin,
                        inventory: data.inventory,
                        technicians: data.technicians,
                        history: data.history,
                        assignments: data.assignments,
                        loading: false
                    });

                    showToast(`Bienvenido, ${currentUser.displayName}`, 'success');
                } catch (error) {
                    console.error('Error inicializando app:', error);
                    showToast('Error cargando la aplicaciÃ³n', 'error');
                    setState({ ...state, loading: false });
                }
            };

            const handleLogin = async () => {
                try {
                    await login();
                    await initializeApp();
                } catch (error) {
                    showToast('Error al iniciar sesiÃ³n', 'error');
                }
            };

            const handleLogout = async () => {
                await logout();
                setState({
                    user: null,
                    isAdmin: false,
                    inventory: [],
                    technicians: [],
                    history: [],
                    activeTab: 'dashboard',
                    loading: false,
                    modalType: null,
                    selectedItem: null
                });
                showToast('SesiÃ³n cerrada correctamente', 'success');
            };

            const handleOpenModal = (type, item) => {
                setState({ ...state, modalType: type, selectedItem: item });
            };

            const handleCloseModal = () => {
                setState({ ...state, modalType: null, selectedItem: null, showConfirm: false, confirmAction: null });
            };

            const handleConfirmAction = async () => {
                const { confirmAction } = state;
                try {
                    if (confirmAction.type === 'eliminar-producto') {
                        await dataManager.deleteInventoryItem(confirmAction.item.id);
                        showToast('Producto eliminado correctamente', 'success');
                    } else if (confirmAction.type === 'eliminar-historial') {
                        await dataManager.deleteHistoryItem(confirmAction.item.id);
                        showToast('Registro eliminado correctamente', 'success');
                    } else if (confirmAction.type === 'toggle-tecnico') {
                        await dataManager.toggleTechnicianStatus(confirmAction.item.id, confirmAction.item.activo);
                        showToast('Estado actualizado', 'success');
                    }
                    await initializeApp();
                    handleCloseModal();
                } catch (error) {
                    showToast('Error al ejecutar la acciÃ³n', 'error');
                }
            };

            const openConfirmModal = (type, item, message) => {
                setState({
                    ...state,
                    showConfirm: true,
                    confirmAction: { type, item },
                    modalType: null
                });
            };

            useEffect(() => {
                if (state.modalType === 'eliminar-producto') {
                    openConfirmModal('eliminar-producto', state.selectedItem, 
                        `Â¿EstÃ¡s seguro de que quieres eliminar "${state.selectedItem.nombre}"?`);
                } else if (state.modalType === 'eliminar-historial') {
                    openConfirmModal('eliminar-historial', state.selectedItem,
                        `Â¿EstÃ¡s seguro de que quieres eliminar el registro del ${new Date(state.selectedItem.fecha).toLocaleDateString()}?`);
                } else if (state.modalType === 'toggle-tecnico') {
                    openConfirmModal('toggle-tecnico', state.selectedItem,
                        `Â¿EstÃ¡s seguro de que quieres ${state.selectedItem.activo ? 'desactivar' : 'activar'} a ${state.selectedItem.nombre}?`);
                }
            }, [state.modalType]);

            if (state.loading) {
                return e('div', { className: 'loading-state', style: { height: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center' } },
                    e('div', { className: 'loading-spinner' }),
                    e('p', null, 'Cargando sistema...')
                );
            }

            if (!state.user) {
                return e(LoginScreen, { onLogin: handleLogin });
            }

            const stats = {
                totalProductos: state.inventory.length,
                totalUnidades: state.inventory.reduce((sum, item) => sum + item.stock, 0),
                stockBajo: state.inventory.filter(item => item.stock > 0 && item.stock <= item.stockMinimo).length,
                movimientosHoy: state.history.filter(h => 
                    new Date(h.fecha).toDateString() === new Date().toDateString()
                ).length
            };

            return e('div', { className: 'app-container' },
                e('header', { className: 'header' },
                    e('div', { className: 'header-left' },
                        e('h1', null, 'Sistema de Inventario IT'),
                        e('div', { className: 'user-badges' },
                            e('span', { className: `user-badge ${state.isAdmin ? 'admin' : 'technician'}` },
                                state.isAdmin ? 'ðŸ‘‘ Admin' : 'ðŸ‘¤ TÃ©cnico', ': ', state.user.name
                            )
                        )
                    ),
                    e('div', { className: 'header-stats' },
                        e('div', { className: 'stat-item' },
                            e('div', { className: 'stat-label' }, 'Productos'),
                            e('div', { className: 'stat-value blue' }, stats.totalProductos)
                        ),
                        e('div', { className: 'stat-item' },
                            e('div', { className: 'stat-label' }, 'Unidades'),
                            e('div', { className: 'stat-value green' }, stats.totalUnidades)
                        ),
                        e('div', { className: 'stat-item' },
                            e('div', { className: 'stat-label' }, 'Stock Bajo'),
                            e('div', { className: 'stat-value orange' }, stats.stockBajo)
                        ),
                        e('button', { className: 'button button-secondary', onClick: handleLogout }, 'ðŸšª Salir')
                    )
                ),

                e('nav', { className: 'nav-tabs' },
                    ['dashboard', 'inventario', 'asignaciones', 'historial'].map(tab =>
                        e('button', {
                            key: tab,
                            className: `tab-button ${state.activeTab === tab ? 'active' : ''}`,
                            onClick: () => setState({ ...state, activeTab: tab })
                        },
                            tab === 'dashboard' ? 'ðŸ“Š' : 
                            tab === 'inventario' ? 'ðŸ“‹' : 
                            tab === 'asignaciones' ? 'ðŸ“„' :
                            'ðŸ“œ',
                            ' ',
                            tab.charAt(0).toUpperCase() + tab.slice(1)
                        )
                    ),
                    state.isAdmin && e('button', {
                        className: `tab-button ${state.activeTab === 'tecnicos' ? 'active' : ''}`,
                        onClick: () => setState({ ...state, activeTab: 'tecnicos' })
                    }, 'ðŸ‘¥ TÃ©cnicos')
                ),

                e('div', { className: 'content-section' },
                    state.activeTab === 'dashboard' && e(Dashboard, { state }),
                    state.activeTab === 'inventario' && e(InventoryView, { 
                        state, 
                        onRefresh: initializeApp,
                        onOpenModal: handleOpenModal
                    }),
                    state.activeTab === 'asignaciones' && e(AssignmentsView, {
                        state,
                        onRefresh: initializeApp,
                        onOpenModal: handleOpenModal
                    }),
                    state.activeTab === 'historial' && e(HistoryView, {
                        state,
                        onRefresh: initializeApp,
                        onOpenModal: handleOpenModal
                    }),
                    state.activeTab === 'tecnicos' && state.isAdmin && e(TechniciansView, {
                        state,
                        onRefresh: initializeApp,
                        onOpenModal: handleOpenModal
                    })
                ),

                state.modalType && !state.showConfirm && ['entrada', 'salida', 'devolucion', 'editar', 'tecnico', 'nueva-asignacion'].includes(state.modalType) &&
                    e(FormModal, {
                        state,
                        modalType: state.modalType,
                        selectedItem: state.selectedItem,
                        onClose: handleCloseModal,
                        onRefresh: initializeApp
                    }),

                state.modalType === 'ver-asignacion' && state.selectedItem &&
                    e(AssignmentDocumentModal, {
                        assignment: state.selectedItem,
                        onClose: handleCloseModal
                    }),

                state.showConfirm && e(ConfirmModal, {
                    message: state.confirmAction?.type === 'eliminar-producto' ? 
                        `Â¿EstÃ¡s seguro de que quieres eliminar "${state.selectedItem?.nombre}"?` :
                        state.confirmAction?.type === 'eliminar-historial' ?
                        `Â¿EstÃ¡s seguro de que quieres eliminar el registro del ${new Date(state.selectedItem?.fecha).toLocaleDateString()}?` :
                        `Â¿EstÃ¡s seguro de que quieres ${state.selectedItem?.activo ? 'desactivar' : 'activar'} a ${state.selectedItem?.nombre}?`,
                    onConfirm: handleConfirmAction,
                    onCancel: handleCloseModal,
                    loading: false
                })
            );
        }

        ReactDOM.render(e(App), document.getElementById('root'));
        }); // Fin window.addEventListener('load')
    </script>
</body>
</html>
